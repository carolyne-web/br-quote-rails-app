<!-- app/views/quotations/new.html.erb -->
<div class="min-h-screen bg-gray-50 flex" data-controller="quotation-form">
  <%= form_with model: @quotation, local: true, class: "w-full flex px-6" do |f| %>
    <!-- Sidebar -->
    <aside class="flex-shrink-0 bg-white shadow-lg flex flex-col sticky top-0 h-screen p-4 justify-between shadow rounded-2xl" style="width: 20%; min-width: 20%;">
      <div class="flex-1 overflow-y-auto">
        <h2 class="text-lg font-semibold mb-4">Quote Sections</h2>
        <ul class="space-y-2 text-sm text-gray-700">
          <li class="font-medium text-blue-600 cursor-pointer" data-section="project-info">Campaign Information</li>
          <li class="cursor-pointer hover:text-blue-600" data-section="talent-categories">Talent Categories</li>
          <li class="cursor-pointer hover:text-blue-600" data-section="licensing">Usage & Licensing</li>
          <li class="cursor-pointer hover:text-blue-600" data-section="guarantee">Quote Preview</li>
        </ul>
      </div>
      <div class="border-t pt-4 flex-shrink-0 hidden">
        <p class="text-sm text-gray-500">Current Total</p>
        <p class="text-2xl font-bold" id="current-total">R 0.00</p>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 space-y-4 px-4 ml-4">
      
      <!-- Error Messages -->
      <% if @quotation.errors.any? %>
        <div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg">
          <h3 class="font-semibold mb-2">Please correct the following errors:</h3>
          <ul class="list-disc list-inside">
            <% @quotation.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>
      
      <!-- Project Information -->
      <section id="project-info" class="bg-white shadow rounded-2xl p-4">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">Campaign Information</h3>
          <span class="text-sm text-gray-400">Step 1 of 4</span>
        </div>
        <div class="grid grid-cols-2 gap-6 mb-4">
          <!-- Campaign Name Column -->
          <div>
            <%= f.label :campaign_name, "Campaign Name", class: "block text-sm font-medium text-gray-600 mb-2" %>
            <%= f.text_field :campaign_name, required: true, class: "w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500", placeholder: "Enter campaign name" %>
          </div>

          <!-- Product Type Column -->
          <div>
            <label class="block text-sm font-medium text-gray-600 mb-2">Product Type</label>
            <div class="flex gap-3">
              <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                <%= f.radio_button :product_type, 'adult', class: "text-blue-600 focus:ring-blue-500" %>
                <span class="text-sm font-medium">Adult Product</span>
              </label>
              <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                <%= f.radio_button :product_type, 'kids', class: "text-blue-600 focus:ring-blue-500" %>
                <span class="text-sm font-medium">Kids Product</span>
              </label>
              <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                <%= f.radio_button :product_type, 'family', class: "text-blue-600 focus:ring-blue-500" %>
                <span class="text-sm font-medium">Family Product</span>
              </label>
            </div>
          </div>

          <div class="hidden">
            <%= f.label :status, "Status", class: "block text-sm font-medium text-gray-600" %>
            <%= f.select :status, options_for_select(Quotation::STATUS_OPTIONS.map { |s| [s.capitalize, s] }, @quotation.status), {}, class: "w-full mt-1 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
          </div>
        </div>

        <!-- Commercial Type Selection -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-600 mb-3">Type of Commercial</label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
              <%= f.radio_button :commercial_type, 'brand', class: "text-blue-600 focus:ring-blue-500", id: "commercial_type_brand" %>
              <span class="text-sm font-medium">Brand Commercial</span>
            </label>
            <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
              <%= f.radio_button :commercial_type, 'non_brand', class: "text-blue-600 focus:ring-blue-500", id: "commercial_type_non_brand" %>
              <span class="text-sm font-medium">Non-Brand Commercial</span>
            </label>
          </div>
        </div>

      </section>

      <!-- Talent Categories -->
      <section id="talent-categories" class="bg-white shadow rounded-2xl p-4">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">Select Talent Categories</h3>
          <span class="text-sm text-gray-400">Step 2 of 4</span>
        </div>
        
        <!-- Talent Category Buttons -->
        <div class="mb-4">
          <div class="flex flex-wrap gap-2">
            <% TalentCategory::TYPES.each do |type_id, type_name| %>
              <button type="button" class="talent-btn flex items-center px-4 py-2 border-2 border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-300 transition-colors text-sm font-medium whitespace-nowrap cursor-pointer" data-category="<%= type_id %>">
                <span class="text-sm font-bold mr-2 text-blue-600"><%= TalentCategory.new(category_type: type_id).icon %></span>
                <span><%= type_name %></span>
              </button>
            <% end %>
          </div>
        </div>
        
        <!-- Selected Talent Categories -->
    <div class="selected-talent-categories">
    <% TalentCategory::TYPES.each do |type_id, type_name| %>
      <div class="talent-category-section hidden mb-8 p-6 bg-gray-50 rounded-lg border-l-4 border-blue-500" id="talent-category-<%= type_id %>">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center">
            <span class="text-2xl mr-3"><%= TalentCategory.new(category_type: type_id).icon %></span>
            <div>
              <h4 class="font-bold text-xl text-gray-900"><%= type_name %></h4>
              
            </div>
          </div>
          <button type="button" class="px-3 py-2 text-sm text-red-600 hover:text-red-800 hover:bg-red-50 rounded-lg transition-colors" data-remove-category data-category="<%= type_id %>">
            Remove Category
          </button>
        </div>
        
        <!-- Talent Input Table -->
        <div class="talent-input-table mb-6">
          <table class="w-full border-collapse">
            <thead>
              <tr>
                <th class="text-xs font-semibold text-gray-700 text-center p-1 w-32">Description</th>
                <th class="text-xs font-semibold text-gray-700 text-center p-1 w-20">Talent</th>
                <th class="text-xs font-semibold text-gray-700 text-center p-1 w-24">Rate +/-</th>
                <th class="text-xs font-semibold text-gray-700 text-center p-1 w-24">Shoot Days</th>
                <th class="text-xs font-semibold text-gray-700 text-center p-1 w-24">Rehearsal</th>
                <th class="text-xs font-semibold text-gray-700 text-center p-1 w-24">Down Days</th>
                <th class="text-xs font-semibold text-gray-700 text-center p-1 w-24">Travel Days</th>
                <th class="text-xs font-semibold text-gray-700 text-center p-1 w-24">Overtime</th>
                <th class="text-xs font-semibold text-gray-700 text-center p-1 w-24">Night</th>
                <th class="text-xs font-semibold text-gray-700 text-center p-1 w-20">Action</th>
              </tr>
            </thead>
            <tbody class="additional-lines" data-category="<%= type_id %>">
              <!-- First Input Row -->
              <tr class="talent-input-row">
                <!-- Description -->
                <td class="p-1">
                  <%= text_field_tag "talent[#{type_id}][description]", "", 
                      class: "talent-description w-full px-2 py-1 text-xs border border-gray-200 rounded focus:ring-1 focus:ring-blue-300 focus:border-blue-300 text-left bg-gray-50",
                      placeholder: "Description",
                      data: { description_input: type_id } %>
                </td>
                
                <!-- Talent Count -->
                <td class="p-1">
                  <%= number_field_tag "talent[#{type_id}][talent_count]", 0, 
                      min: 0, max: 99,
                      class: "w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-300 focus:border-blue-300 text-center",
                      data: { talent_input: type_id } %>
                </td>

                  <!-- Rate Adjustment -->
                <td class="p-1">
                  <%= number_field_tag "talent[#{type_id}][adjusted_rate]", 
                          TalentCategory.new(category_type: type_id).default_daily_rate,
                      min: 0,
                      step: 100,
                      class: "w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-300 focus:border-blue-300 text-center",
                      data: { adjusted_rate_input: type_id },
                      title: "Full adjusted rate" %>
                </td>

                <!-- Days Count -->
                <td class="p-1">
                  <%= number_field_tag "talent[#{type_id}][days_count]", 1, 
                      min: 1,
                      class: "w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-300 focus:border-blue-300 text-center",
                      data: { days_input: type_id } %>
                </td>
                
                <!-- Rehearsal Days (50% rate) -->
                <td class="p-1">
                  <%= number_field_tag "talent[#{type_id}][rehearsal_days]", 0, 
                      min: 0,
                      class: "w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-300 focus:border-blue-300 text-center",
                      data: { rehearsal_input: type_id },
                      title: "50% of day rate" %>
                </td>
                
                <!-- Down Days (50% rate) -->
                <td class="p-1">
                  <%= number_field_tag "talent[#{type_id}][down_days]", 0, 
                      min: 0,
                      class: "w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-300 focus:border-blue-300 text-center",
                      data: { down_input: type_id },
                      title: "50% of day rate" %>
                </td>
                
                <!-- Travel Days (50% rate) -->
                <td class="p-1">
                  <%= number_field_tag "talent[#{type_id}][travel_days]", 0, 
                      min: 0,
                      class: "w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-300 focus:border-blue-300 text-center",
                      data: { travel_input: type_id },
                      title: "50% of day rate" %>
                </td>
                
                <!-- Overtime Hours (10% per hour) -->
                <td class="p-1">
                  <%= number_field_tag "talent[#{type_id}][overtime_hours]", 0, 
                      min: 0, step: 0.5,
                      class: "w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-300 focus:border-blue-300 text-center",
                      data: { overtime_input: type_id },
                      title: "10% of day rate per hour" %>
                </td>
                
                <!-- Night Button -->
                <td class="p-1 text-center">
                  <button type="button" 
                          class="night-btn w-full px-2 py-1 text-xs border-2 border-gray-300 rounded hover:bg-yellow-50 hover:border-yellow-300 transition-colors font-medium"
                          data-category="<%= type_id %>"
                          data-active="false"
                          title="Night shoot calculation">
                    + Night Fee
                  </button>
                  <input type="number" 
                        name="talent[<%= type_id %>][night_count]" 
                        min="1" 
                        value="1" 
                        class="nights-input w-full px-1 py-1 text-xs border border-gray-300 rounded text-center hidden"
                        data-category="<%= type_id %>"
                        placeholder="Nights">
                  <%= hidden_field_tag "talent[#{type_id}][night_premium]", "false", data: { night_field: type_id } %>
                </td>
                
                <!-- Action Button - Add Line -->
                <td class="p-1 text-center">
                  <button type="button"
                          class="add-line-btn w-full px-2 py-1 text-xs text-blue-600 rounded font-medium"
                          data-category="<%= type_id %>"
                          title="Add another talent line">
                    + Line
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- Category Total Display -->
        <div class="category-total p-4 bg-blue-50 rounded-lg">
          <div class="flex justify-between items-center">
            <span class="font-semibold text-gray-900"><%= type_name %> Total:</span>
            <span class="text-lg font-bold text-blue-600" id="category-total-<%= type_id %>">R0</span>
          </div>
          
        </div>
      </div>
    <% end %>
  </div>
  
  <!-- Talent Category Totals -->
  <div id="category-totals" class="mt-6 bg-blue-50 rounded-lg p-4 border border-blue-200">
    <h4 class="text-lg font-semibold mb-3 text-gray-800">Talent Summary</h4>
    <div id="category-totals-list" class="space-y-2">
      <!-- Category totals will be populated by JavaScript -->
    </div>
    <div class="border-t border-blue-200 mt-4 pt-4">
      <%# <div class="flex justify-between items-center">
        <span class="font-semibold text-gray-800 hidden">Total (without days):</span>
        <span class="text-xl font-bold text-blue-600 hidden" id="talent-base-total">R0</span>
      </div> %>
      <div class="flex justify-between items-center">
        <span class="font-semibold text-gray-800">Total Talent Daily Fees</span>
        <span class="text-xl font-bold text-blue-600" id="talent-grand-total">R0</span>
      </div>
    </div>
  </div>
</section>



      <!-- Usage & Licensing -->
      <%= fields_for :quotation_detail, @quotation.quotation_detail || @quotation.build_quotation_detail do |detail_fields| %>
        <!-- Hidden field to maintain form compatibility -->
        <%= detail_fields.hidden_field :shoot_days, value: 1 %>
        <section id="licensing" class="bg-white shadow rounded-2xl p-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">Usage & Licensing</h3>
            <span class="text-sm text-gray-400">Step 3 of 4</span>
          </div>
          
          <!-- Territory Combinations Tabs -->
          <div class="mb-4">
            <div class="flex items-center space-x-2 border-b border-gray-200">
              <div id="combination-tabs" class="flex space-x-2">
                <button type="button" class="combination-tab px-4 py-2 border-b-2 border-blue-500 text-blue-600 font-medium text-sm" data-combo="1">
                  Group 1
                </button>
              </div>
              <button type="button" id="add-combination" class="ml-2 px-3 py-1 text-sm text-blue-600 hover:text-blue-800 border border-blue-300 rounded-lg hover:bg-blue-50 transition-colors">
                + Add Group
              </button>
            </div>
          </div>

          <!-- Territory Combinations Content -->
          <div id="combinations-content">
            <!-- Combination 1 -->
            <div class="combination-content active" data-combo="1">
              <div class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-600 mb-3" for="combination_1_duration">Contract Duration</label>
                    <select name="combinations[1][duration]" id="combination_1_duration" class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 combination-duration" data-combo="1">
                      <option value="">Select Contract Duration</option>
                      <option value="3_months">Up to 3 Months</option>
                      <option value="6_months">Up to 6 Months</option>
                      <option value="12_months">12 Months</option>
                      <option value="18_months">18 Months</option>
                      <option value="24_months">2 Years</option>
                      <option value="36_months">36 Months</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-600 mb-3" for="combination_1_commercials">Number of Commercials</label>
                    <input type="number" name="combinations[1][number_of_commercials]" id="combination_1_commercials" min="1" max="20" value="1" class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 combination-commercials" data-combo="1">
                  </div>
                </div>

                <!-- Territory Selection for this Combination -->
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-3">Select Territories for Group 1</label>
                  
                  <!-- Selected Territory Tags -->
                  <div>
                    <div class="selected-territory-tags flex flex-wrap gap-2" data-combo="1">
                      <!-- Selected territory tags will appear here -->
                    </div>
                  </div>
                  
                  <!-- <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 hidden">
                    <div class="text-sm text-blue-800">
                      <strong>Territory Logic:</strong> Multiple territories are additive. Example: East Europe (400%) + Pan African (400%) = 800% total.
                    </div>
                  </div> -->
                  
                  <!-- Search Bar -->
                  <div class="mb-4">
                    <input type="text" class="territory-search w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" data-combo="1" placeholder="Search territories...">
                  </div>
                  
                  <!-- Territories List -->
                  <div class="max-h-80 overflow-y-auto border border-gray-200 rounded-lg">
                    <div class="territories-list space-y-1 p-2" data-combo="1">
                      <% @territories.group_by { |t| t.group_name.present? ? t.group_name : "Individual Countries" }.each do |group_name, territories| %>
                        <% territories.each do |territory| %>
                          <label class="territory-item flex items-center justify-between p-2 border-b border-gray-100 hover:bg-gray-50 cursor-pointer" data-name="<%= territory.name.downcase %>">
                            <div class="flex items-center">
                              <input type="checkbox" name="combinations[1][territories][]" value="<%= territory.id %>" class="mr-3 rounded text-blue-600 focus:ring-blue-500 combination-territory-checkbox" data-territory-id="<%= territory.id %>" data-territory-name="<%= territory.name %>" data-percentage="<%= territory.percentage %>" data-combo="1">
                              <div class="text-sm">
                                <div class="font-medium text-gray-900"><%= territory.name %></div>
                                <div class="text-xs text-gray-500"><%= group_name %></div>
                              </div>
                            </div>
                            <div class="text-sm font-medium text-blue-600"><%= territory.percentage %>%</div>
                          </label>
                        <% end %>
                      <% end %>
                    </div>
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-3">Select Media Type(s)</label>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                    <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                      <input type="checkbox" name="combinations[1][media_types][]" value="all_media" class="mr-3 rounded text-blue-600 focus:ring-blue-500 combination-media" data-combo="1">
                      <span class="text-sm font-medium">All Media</span>
                    </label>
                    <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                      <input type="checkbox" name="combinations[1][media_types][]" value="cinema" class="mr-3 rounded text-blue-600 focus:ring-blue-500 combination-media" data-combo="1">
                      <span class="text-sm font-medium">Cinema Only</span>
                    </label>
                    <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                      <input type="checkbox" name="combinations[1][media_types][]" value="all_moving" class="mr-3 rounded text-blue-600 focus:ring-blue-500 combination-media" data-combo="1">
                      <span class="text-sm font-medium">All Moving Media</span>
                    </label>
                    <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                      <input type="checkbox" name="combinations[1][media_types][]" value="tv" class="mr-3 rounded text-blue-600 focus:ring-blue-500 combination-media" data-combo="1">
                      <span class="text-sm font-medium">TV Only</span>
                    </label>
                    <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                      <input type="checkbox" name="combinations[1][media_types][]" value="print" class="mr-3 rounded text-blue-600 focus:ring-blue-500 combination-media" data-combo="1">
                      <span class="text-sm font-medium">All Print Media</span>
                    </label>
                    <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                      <input type="checkbox" name="combinations[1][media_types][]" value="internet" class="mr-3 rounded text-blue-600 focus:ring-blue-500 combination-media" data-combo="1">
                      <span class="text-sm font-medium">Internet Only</span>
                    </label>
                  </div>
                  
                  <!-- <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 hidden">
                    <div class="text-sm text-blue-800">
                      <strong>Media Multiplier Logic:</strong> All Media = 100%, All Moving Media alone = 75%, All Moving Media + 1 other = 75%, 1 other media = 50%, 3+ media = 100%
                    </div>
                    <div class="text-xs text-blue-600 mt-1">
                      Current multiplier: <span class="media-multiplier-display" data-combo="1">100%</span>
                    </div>
                  </div> -->
                </div>
                
                
                <div class="space-y-2">
                  <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
                    <input type="checkbox" name="combinations[1][unlimited_stills]" value="1" class="mr-3 rounded text-blue-600 focus:ring-blue-500 combination-unlimited-stills" data-combo="1">
                    <span class="text-sm">Unlimited Stills (+15%)</span>
                  </label>
                  <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
                    <input type="checkbox" name="combinations[1][unlimited_versions]" value="1" class="mr-3 rounded text-blue-600 focus:ring-blue-500 combination-unlimited-versions" data-combo="1">
                    <span class="text-sm">Unlimited Versions (+15%)</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </section>
      <% end %>

      <!-- Guarantee & Manual Adjustments -->
      <section class="hidden bg-white shadow rounded-2xl p-4">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">Guarantee & Manual Adjustments</h3>
        </div>
        
        <!-- Guarantee Option -->
        <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
          <label class="flex items-center">
            <%= f.check_box :is_guaranteed, class: "mr-3 rounded text-blue-600 focus:ring-blue-500" %>
            <span class="text-sm font-medium">Apply 25% Guarantee Discount?</span>
          </label>
          <div class="text-xs text-gray-600 mt-2">
            When selected, the final quote will be reduced by 25% as a guarantee discount.
          </div>
        </div>
        
        <!-- Manual Adjustments -->
        <div class="manual-adjustments">
          <h4 class="text-md font-medium text-gray-700 mb-3">Manual Adjustments</h4>
          <div class="mb-3">
            <button type="button" class="text-sm text-blue-600 hover:text-blue-800 add-adjustment">
              + Add Adjustment
            </button>
          </div>
          <div id="adjustments-container">
            <!-- Manual adjustments will be added here dynamically -->
          </div>
        </div>
      </section>

      <!-- Quote Preview -->
      <section id="guarantee" class="bg-white shadow rounded-2xl p-4">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold mb-4">Quote Preview</h3>
        <span class="text-sm text-gray-400">Step 4 of 4</span>
        </div>
        
        <!-- Group Tables Container -->
        <div id="combo-tables-container">
          <!-- Group 1 -->
          <div class="combo-table-section mb-6" data-combo="1">
            <!-- Dynamic Group Pills -->
            <div class="combo-summary-pills mb-4 flex flex-wrap gap-2" data-combo="1">
              <!-- Pills will be populated by JavaScript -->
            </div>
            
            <div class="bg-gray-50 rounded-lg p-4">
              <!-- Talent Lines Table -->
              <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-gray-300 quote-preview-table">
                  <thead>
                    <tr class="bg-gray-100 border-b border-gray-300">
                      <th class="text-center py-2 px-3 text-sm font-medium text-gray-700 border-r border-gray-300">Talent</th>
                      <th class="text-center py-2 px-3 text-sm font-medium text-gray-700 border-r border-gray-300">Day Fee</th>
                      <th class="text-center py-2 px-3 text-sm font-medium text-gray-700 border-r border-gray-300">Unit</th>
                      <th class="text-center py-2 px-3 text-sm font-medium text-gray-700 border-r border-gray-300">Exclusivity</th>
                      <th class="text-center py-2 px-3 text-sm font-medium text-gray-700 border-r border-gray-300">Buyout %</th>
                      <th class="text-center py-2 px-3 text-sm font-medium text-gray-700 border-r border-gray-300">Per Talent</th>
                      <th class="text-center py-2 px-3 text-sm font-medium text-gray-700">Total (R)</th>
                    </tr>
                  </thead>
                  <tbody class="quote-preview-rows" data-combo="1">
                    <!-- Talent lines will be populated here -->
                  </tbody>
                  <%# <tfoot>
                    <tr class="border-t border-gray-400 font-semibold bg-gray-50">
                      <td colspan="5" class="text-right py-2 px-3 text-sm text-gray-800 border-r border-gray-300">Total:</td>
                      
                    </tr>
                  </tfoot> %>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Form Actions -->
      <div class="bg-white rounded-2xl p-4 shadow">
        <div class="flex flex-col space-y-3 sm:flex-row sm:space-y-0 sm:space-x-3 sm:justify-end">
          <%= link_to "Cancel", quotations_path, 
              class: "px-6 py-2 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition text-center" %>
          <%= f.submit "Generate Quote", 
              class: "px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition" %>
        </div>
      </div>
    </main>
  <% end %>
</div>


<script>
// Make exclusivity options available to JavaScript
const exclusivityOptions = <%= @exclusivity_options.to_json.html_safe %>;
// Make raw exclusivity settings available for popup
const exclusivitySettings = <%= @exclusivity_settings.to_json.html_safe %>;

document.addEventListener('DOMContentLoaded', function() {
  console.log('DOMContentLoaded fired - checking elements...');
  console.log('add-combination button:', document.getElementById('add-combination'));
  // Sidebar navigation
  const sidebarItems = document.querySelectorAll('[data-section]');
  const sections = document.querySelectorAll('section[id]');
  
  sidebarItems.forEach(item => {
    item.addEventListener('click', function() {
      const targetSection = document.getElementById(this.dataset.section);
      if (targetSection) {
        targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // Update active sidebar item
        sidebarItems.forEach(i => {
          i.classList.remove('font-medium', 'text-blue-600');
          i.classList.add('text-gray-700');
        });
        this.classList.add('font-medium', 'text-blue-600');
        this.classList.remove('text-gray-700');
      }
    });
  });

  // Territory Combinations Management
  // Removed nextComboId global variable - now calculating dynamically
  
  // Tab switching functionality
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('combination-tab')) {
      const comboId = e.target.getAttribute('data-combo');
      switchToCombination(comboId);
    }
  });
  
  function switchToCombination(comboId) {
    // Update tab styles
    document.querySelectorAll('.combination-tab').forEach(tab => {
      tab.classList.remove('border-blue-500', 'text-blue-600', 'font-medium');
      tab.classList.add('border-transparent', 'text-gray-500');
    });
    
    const activeTab = document.querySelector(`[data-combo="${comboId}"].combination-tab`);
    if (activeTab) {
      activeTab.classList.add('border-blue-500', 'text-blue-600', 'font-medium');
      activeTab.classList.remove('border-transparent', 'text-gray-500');
    }
    
    // Update content visibility
    document.querySelectorAll('.combination-content').forEach(content => {
      content.classList.remove('active');
      content.style.display = 'none';
    });
    
    const activeContent = document.querySelector(`[data-combo="${comboId}"].combination-content`);
    if (activeContent) {
      activeContent.classList.add('active');
      activeContent.style.display = 'block';
    }
  }
  
  // Add new combination functionality
  const addCombinationBtn = document.getElementById('add-combination');
  console.log('🔍 Looking for add-combination button:', addCombinationBtn);
  console.log('🔍 Button exists:', !!addCombinationBtn);
  console.log('🔍 Button disabled:', addCombinationBtn?.disabled);
  console.log('🔍 Button classes:', addCombinationBtn?.className);

  if (addCombinationBtn) {
    console.log('✅ Add combination button found, adding listener');

    // DISABLED: Now handled by Stimulus controller to prevent duplicate tabs
    /*
    addCombinationBtn.addEventListener('click', function(event) {
      console.log('🚀🚀🚀 Add combination button clicked!');
      console.log('🚀 Event details:', { type: event.type, target: event.target, currentTarget: event.currentTarget });
      console.log('🚀 Button state:', { disabled: this.disabled, className: this.className });
      // Calculate next combo ID based on existing combos (not a global counter)
      const existingTabs = document.querySelectorAll('.combination-tab');
      const newComboId = existingTabs.length + 1;
      console.log('Creating new group with ID:', newComboId);
      
      // Add new tab
      const tabsContainer = document.getElementById('combination-tabs');
      const newTab = document.createElement('button');
      newTab.type = 'button';
      newTab.className = 'combination-tab px-4 py-2 border-b-2 border-transparent text-gray-500 text-sm hover:text-blue-600';
      newTab.setAttribute('data-combo', newComboId);
      newTab.textContent = `Group ${newComboId}`;
      
      // Add remove button directly to the tab
      newTab.innerHTML = `Group ${newComboId} <span class="ml-2 text-red-500 hover:text-red-700 remove-combo-btn" data-combo-id="${newComboId}">×</span>`;
      
      tabsContainer.appendChild(newTab);
      
      // Add new content
      const contentContainer = document.getElementById('combinations-content');
      const newContent = createCombinationContent(newComboId);
      contentContainer.appendChild(newContent);

      // Setup commercial input listener for new combo (with delay to ensure DOM is ready)
      setTimeout(() => {
        const newCommercialInput = document.querySelector(`input[name="combinations[${newComboId}][number_of_commercials]"]`);
        if (newCommercialInput) {
          newCommercialInput.addEventListener('input', () => {
            if (typeof window.quotationFormController !== 'undefined') {
              window.quotationFormController.populateAllTables();
            }
          });

          // Prevent form submission on Enter key
          newCommercialInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              newCommercialInput.blur(); // Remove focus from input
            }
          });
        }
      }, 100);

      // Add new combo table
      createComboTable(newComboId);
      
      // Switch to new combination
      switchToCombination(newComboId);
      
      // Update quote preview
      if (typeof updateQuotePreview === 'function') {
        updateQuotePreview();
      }
    */
  } else {
    console.error('Add combination button not found!');
  }
  
  function removeCombination(comboId) {
    console.log('Removing combination:', comboId);
    if (comboId == 1) {
      console.log('Cannot remove group 1');
      return; // Cannot remove group 1
    }
    
    // Remove tab
    const tab = document.querySelector(`button[data-combo="${comboId}"].combination-tab`);
    console.log('Found tab to remove:', tab);
    if (tab) {
      tab.remove();
    }
    
    // Remove content
    const content = document.querySelector(`div[data-combo="${comboId}"].combination-content`);
    console.log('Found content to remove:', content);
    if (content) {
      content.remove();
    }
    
    // Remove combo table
    const comboTable = document.querySelector(`div[data-combo="${comboId}"].combo-table-section`);
    console.log('Found combo table to remove:', comboTable);
    if (comboTable) {
      comboTable.remove();
    }
    
    // Renumber all remaining tabs and content sequentially
    renumberCombinations();
    
    // Switch to group 1 if no active tab remains
    const activeTab = document.querySelector('.combination-tab.border-blue-500');
    console.log('Active tab after removal:', activeTab);
    if (!activeTab) {
      console.log('Switching to combination 1');
      switchToCombination(1);
    }
    
    // Update quote preview
    if (typeof updateQuotePreview === 'function') {
      updateQuotePreview();
    }
  }
  
  function createComboTable(comboId) {
    console.log('Creating combo table for:', comboId);
    const container = document.getElementById('combo-tables-container');
    
    const comboTableSection = document.createElement('div');
    comboTableSection.className = 'combo-table-section mb-6';
    comboTableSection.setAttribute('data-combo', comboId);
    
    comboTableSection.innerHTML = `
      <!-- Dynamic Group Pills -->
      <div class="combo-summary-pills mb-4 flex flex-wrap gap-2" data-combo="${comboId}">
        <!-- Pills will be populated by JavaScript -->
      </div>
      
      <div class="bg-gray-50 rounded-lg p-4">
        <!-- Talent Lines Table -->
        <div class="overflow-x-auto">
          <table class="w-full border-collapse border border-gray-300 quote-preview-table">
            <thead>
              <tr class="bg-gray-100 border-b border-gray-300">
                <th class="text-center py-2 px-3 text-sm font-medium text-gray-700 border-r border-gray-300">Talent</th>
                <th class="text-center py-2 px-3 text-sm font-medium text-gray-700 border-r border-gray-300">Day Fee</th>
                <th class="text-center py-2 px-3 text-sm font-medium text-gray-700 border-r border-gray-300">Unit</th>
                <th class="text-center py-2 px-3 text-sm font-medium text-gray-700 border-r border-gray-300">Exclusivity</th>
                <th class="text-center py-2 px-3 text-sm font-medium text-gray-700 border-r border-gray-300">Buyout %</th>
                <th class="text-center py-2 px-3 text-sm font-medium text-gray-700 border-r border-gray-300">Per Talent</th>
                <th class="text-center py-2 px-3 text-sm font-medium text-gray-700">Total (R)</th>
              </tr>
            </thead>
            <tbody class="quote-preview-rows" data-combo="${comboId}">
              <!-- Talent lines will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    `;
    
    container.appendChild(comboTableSection);
    
    // Update the combo summary for this new combo
    if (window.quotationController && typeof window.quotationController.updateComboSummary === 'function') {
      window.quotationController.updateComboSummary(comboId);
    }
  }

  // Make createComboTable available globally for the Stimulus controller
  window.createComboTable = createComboTable;
  
  function renumberCombinations() {
    console.log('Renumbering combinations...');
    const tabsContainer = document.getElementById('combination-tabs');
    const allTabs = Array.from(tabsContainer.querySelectorAll('.combination-tab'));
    
    // Renumber tabs and update their content
    allTabs.forEach((tab, index) => {
      const newComboId = index + 1;
      const oldComboId = tab.getAttribute('data-combo');
      console.log(`Renumbering group ${oldComboId} to ${newComboId}`);
      
      // Update tab attributes and content
      tab.setAttribute('data-combo', newComboId);
      tab.innerHTML = `Group ${newComboId} <span class="ml-2 text-red-500 hover:text-red-700 remove-combo-btn" data-combo-id="${newComboId}">×</span>`;
      
      // Find and update corresponding content
      const content = document.querySelector(`div[data-combo="${oldComboId}"].combination-content`);
      if (content) {
        content.setAttribute('data-combo', newComboId);
        
        // Update all form field names within this content
        updateFormFieldNames(content, oldComboId, newComboId);
        
        // Update territory tags container
        const territoryTags = content.querySelector('.selected-territory-tags');
        if (territoryTags) {
          territoryTags.setAttribute('data-combo', newComboId);
        }
      }
      
      // Find and update corresponding combo table
      const comboTable = document.querySelector(`div[data-combo="${oldComboId}"].combo-table-section`);
      if (comboTable) {
        comboTable.setAttribute('data-combo', newComboId);
        
        // Update all data-combo attributes within the combo table
        comboTable.querySelectorAll('[data-combo]').forEach(element => {
          if (element.getAttribute('data-combo') == oldComboId) {
            element.setAttribute('data-combo', newComboId);
          }
        });
      }
    });
    
    console.log('Renumbering complete');
  }
  
  function updateFormFieldNames(content, oldComboId, newComboId) {
    // Update all input field names
    content.querySelectorAll('input, select, textarea').forEach(field => {
      if (field.name && field.name.includes(`combinations[${oldComboId}]`)) {
        field.name = field.name.replace(`combinations[${oldComboId}]`, `combinations[${newComboId}]`);
        console.log(`Updated field name to: ${field.name}`);
      }
    });
    
    // Update data-combo attributes
    content.querySelectorAll('[data-combo]').forEach(element => {
      if (element.getAttribute('data-combo') == oldComboId) {
        element.setAttribute('data-combo', newComboId);
      }
    });
  }
  
  // Function will be handled by controller event delegation
  
  // Add event delegation for remove combination buttons
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-combo-btn')) {
      e.preventDefault();
      e.stopPropagation();
      const comboId = e.target.getAttribute('data-combo-id');
      console.log('Remove button clicked for combo:', comboId);
      removeCombination(parseInt(comboId));
    }
  });
  
  
  
  function createCombinationContent(comboId) {
    const content = document.createElement('div');
    content.className = 'combination-content';
    content.setAttribute('data-combo', comboId);
    content.style.display = 'none';
    
    content.innerHTML = `
      <div class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-600" for="combination_${comboId}_duration">Contract Duration</label>
            <select name="combinations[${comboId}][duration]" id="combination_${comboId}_duration" class="w-full mt-1 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 combination-duration" data-combo="${comboId}">
              <option value="">Select Contract Duration</option>
              <option value="3_months">Up to 3 Months</option>
              <option value="6_months">Up to 6 Months</option>
              <option value="12_months">12 Months</option>
              <option value="18_months">18 Months</option>
              <option value="24_months">2 Years</option>
              <option value="36_months">36 Months</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-600" for="combination_${comboId}_commercials">Number of Commercials</label>
            <input type="number" name="combinations[${comboId}][number_of_commercials]" id="combination_${comboId}_commercials" min="1" max="20" value="1" class="w-full mt-1 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 combination-commercials" data-combo="${comboId}">
          </div>
        </div>

        <!-- Territory Selection for this Combination -->
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-3">Select Territories for Group ${comboId}</label>
          
          <!-- Selected Territory Tags -->
          <div>
            <div class="selected-territory-tags flex flex-wrap gap-2" data-combo="${comboId}">
              <!-- Selected territory tags will appear here -->
            </div>
          </div>
          
          <!-- <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
            <div class="text-sm text-blue-800">
              <strong>Territory Logic:</strong> Multiple territories are additive. Example: East Europe (400%) + Pan African (400%) = 800% total.
            </div>
          </div> -->
          
          <!-- Search Bar -->
          <div class="mb-4">
            <input type="text" class="territory-search w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" data-combo="${comboId}" placeholder="Search territories...">
          </div>
          
          <!-- Territories List -->
          <div class="max-h-80 overflow-y-auto border border-gray-200 rounded-lg">
            <div class="territories-list space-y-1 p-2" data-combo="${comboId}">
              <!-- Territories will be populated by JavaScript -->
            </div>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-600 mb-3">Select Media Type(s)</label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
            <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
              <input type="checkbox" name="combinations[${comboId}][media_types][]" value="all_media" class="mr-3 rounded text-blue-600 focus:ring-blue-500 combination-media" data-combo="${comboId}">
              <span class="text-sm font-medium">All Media</span>
            </label>
            <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
              <input type="checkbox" name="combinations[${comboId}][media_types][]" value="cinema" class="mr-3 rounded text-blue-600 focus:ring-blue-500 combination-media" data-combo="${comboId}">
              <span class="text-sm font-medium">Cinema Only</span>
            </label>
            <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
              <input type="checkbox" name="combinations[${comboId}][media_types][]" value="all_moving" class="mr-3 rounded text-blue-600 focus:ring-blue-500 combination-media" data-combo="${comboId}">
              <span class="text-sm font-medium">All Moving Media</span>
            </label>
            <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
              <input type="checkbox" name="combinations[${comboId}][media_types][]" value="tv" class="mr-3 rounded text-blue-600 focus:ring-blue-500 combination-media" data-combo="${comboId}">
              <span class="text-sm font-medium">TV Only</span>
            </label>
            <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
              <input type="checkbox" name="combinations[${comboId}][media_types][]" value="print" class="mr-3 rounded text-blue-600 focus:ring-blue-500 combination-media" data-combo="${comboId}">
              <span class="text-sm font-medium">All Print Media</span>
            </label>
            <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
              <input type="checkbox" name="combinations[${comboId}][media_types][]" value="internet" class="mr-3 rounded text-blue-600 focus:ring-blue-500 combination-media" data-combo="${comboId}">
              <span class="text-sm font-medium">Internet Only</span>
            </label>
          </div>
          
          <!-- <div class="media-multiplier-logic-block bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
            <div class="text-sm text-blue-800">
              <strong>Media Multiplier Logic:</strong> All Media = 100%, All Moving Media alone = 75%, All Moving Media + 1 other = 75%, 1 other media = 50%, 3+ media = 100%
            </div>
            <div class="text-xs text-blue-600 mt-1">
              Current multiplier: <span class="media-multiplier-display" data-combo="${comboId}">100%</span>
            </div>
          </div> -->
        </div>
        
        <div class="space-y-2">
          <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="combinations[${comboId}][unlimited_stills]" value="1" class="mr-3 rounded text-blue-600 focus:ring-blue-500 combination-unlimited-stills" data-combo="${comboId}">
            <span class="text-sm">Unlimited Stills (+15%)</span>
          </label>
          <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="combinations[${comboId}][unlimited_versions]" value="1" class="mr-3 rounded text-blue-600 focus:ring-blue-500 combination-unlimited-versions" data-combo="${comboId}">
            <span class="text-sm">Unlimited Versions (+15%)</span>
          </label>
        </div>
      </div>
    `;

    // Populate territories list with JavaScript after DOM creation
    setTimeout(() => {
      console.log('📝 Populating territories for combo:', comboId);
      const territoriesList = content.querySelector(`.territories-list[data-combo="${comboId}"]`);
      console.log('Territories list element found:', !!territoriesList);
      if (territoriesList) {
        const html = generateTerritoriesHTML(comboId);
        console.log('Generated HTML length:', html.length);
        territoriesList.innerHTML = html;
        console.log('✅ Territories populated for combo:', comboId);
      } else {
        console.error('❌ Could not find territories list for combo:', comboId);
      }
    }, 0);

    return content;
  }

  // Initialize first combination as active
  switchToCombination(1);

  // Territory search functionality for combinations
  document.addEventListener('input', function(e) {
    if (e.target.classList.contains('territory-search')) {
      console.log('🔍 Territory search triggered');
      const comboId = e.target.getAttribute('data-combo');
      const searchTerm = e.target.value.toLowerCase();
      console.log('Search term:', searchTerm, 'for combo:', comboId);
      const territoriesList = document.querySelector(`.territories-list[data-combo="${comboId}"]`);
      console.log('Territories list found:', !!territoriesList);
      
      if (territoriesList) {
        const territoryItems = territoriesList.querySelectorAll('.territory-item');
        
        if (searchTerm.length >= 1) {
          territoryItems.forEach(item => {
            const territoryName = item.dataset.name;
            if (territoryName && territoryName.toLowerCase().includes(searchTerm)) {
              item.style.display = '';
            } else {
              item.style.display = 'none';
            }
          });
        } else {
          territoryItems.forEach(item => {
            item.style.display = '';
          });
        }
      }
    }
  });


  // Media multiplier calculation function for a specific combination (matching controller logic)
  function calculateMediaMultiplierForCombo(comboId) {
    const selected = document.querySelectorAll(`input[name="combinations[${comboId}][media_types][]"]:checked`);
    const allMediaSelected = document.querySelector(`input[name="combinations[${comboId}][media_types][]"][value="all_media"]:checked`);
    const allMovingSelected = document.querySelector(`input[name="combinations[${comboId}][media_types][]"][value="all_moving"]:checked`);
    const allPrintSelected = document.querySelector(`input[name="combinations[${comboId}][media_types][]"][value="print"]:checked`);
    let multiplier = 1.0;
    
    if (allMediaSelected) {
      multiplier = 1.0; // All Media = 100%
    } else if (allMovingSelected && allPrintSelected) {
      // All Moving + All Print should auto-select All Media, but just in case
      multiplier = 1.0; // = 100%
    } else if (allMovingSelected) {
      multiplier = 0.75; // All Moving Media = 75%
    } else if (allPrintSelected) {
      multiplier = 0.75; // All Print Media = 75%
    } else if (selected.length === 1) {
      multiplier = 0.5; // One individual media = 50%
    } else if (selected.length >= 3) {
      multiplier = 1.0; // Three or more individual media = 100%
    } else if (selected.length === 2) {
      multiplier = 0.75; // Two individual media = 75%
    } else {
      multiplier = 1.0; // No selection defaults to 100%
    }
    
    // Update the display for this combination
    const displayElement = document.querySelector(`.media-multiplier-display[data-combo="${comboId}"]`);
    if (displayElement) {
      displayElement.textContent = `${Math.round(multiplier * 100)}%`;
    }
    
    return multiplier;
  }

  // Duration multiplier calculation function for a specific combination
  function calculateDurationMultiplierForCombo(comboId) {
    const durationSelect = document.querySelector(`select[name="combinations[${comboId}][duration]"]`);
    if (!durationSelect || !durationSelect.value) {
      return 1.0; // Default multiplier
    }
    
    // Map duration values to multipliers using settings
    const durationMultipliers = {
      '3_months': <%= Setting.find_by(key: 'duration_3_months')&.typed_value || 50 %> / 100,
      '6_months': <%= Setting.find_by(key: 'duration_6_months')&.typed_value || 75 %> / 100,
      '12_months': <%= Setting.find_by(key: 'duration_12_months')&.typed_value || 100 %> / 100,
      '18_months': <%= Setting.find_by(key: 'duration_18_months')&.typed_value || 175 %> / 100,
      '24_months': <%= Setting.find_by(key: 'duration_24_months')&.typed_value || 200 %> / 100,
      '36_months': <%= Setting.find_by(key: 'duration_36_months')&.typed_value || 300 %> / 100
    };
    
    return durationMultipliers[durationSelect.value] || 1.0;
  }

  // Territory multiplier calculation function for a specific combination
  function calculateTerritoryMultiplierForCombo(comboId) {
    const selectedTerritories = document.querySelectorAll(`input[name="combinations[${comboId}][territories][]"]:checked`);
    let totalTerritoryPercentage = 0;
    
    selectedTerritories.forEach(checkbox => {
      const percentage = parseFloat(checkbox.dataset.percentage) || 0;
      totalTerritoryPercentage += percentage;
    });
    
    return totalTerritoryPercentage > 0 ? totalTerritoryPercentage / 100.0 : 1.0;
  }


  // Get all active combinations
  function getActiveCombinations() {
    const combinations = [];
    const allCombinations = document.querySelectorAll('.combination-content');
    
    allCombinations.forEach(combo => {
      const comboId = combo.getAttribute('data-combo');
      const durationSelect = document.querySelector(`select[name="combinations[${comboId}][duration]"]`);
      const selectedTerritories = document.querySelectorAll(`input[name="combinations[${comboId}][territories][]"]:checked`);
      const selectedMedia = document.querySelectorAll(`input[name="combinations[${comboId}][media_types][]"]:checked`);
      
      // Only include combinations that have at least duration, territory, or media selected
      if ((durationSelect && durationSelect.value) || selectedTerritories.length > 0 || selectedMedia.length > 0) {
        combinations.push({
          id: comboId,
          territoryMultiplier: calculateTerritoryMultiplierForCombo(comboId),
          mediaMultiplier: calculateMediaMultiplierForCombo(comboId),
          durationMultiplier: calculateDurationMultiplierForCombo(comboId),
          exclusivityMultiplier: 1.0, // Now handled by new pill system
          unlimitedStills: document.querySelector(`input[name="combinations[${comboId}][unlimited_stills]"]:checked`) ? true : false,
          unlimitedVersions: document.querySelector(`input[name="combinations[${comboId}][unlimited_versions]"]:checked`) ? true : false,
          selectedTerritories: Array.from(selectedTerritories).map(t => t.dataset.territoryName),
          selectedMedia: Array.from(selectedMedia).map(m => m.value),
          duration: durationSelect ? durationSelect.value : ''
        });
      }
    });
    
    return combinations;
  }

  // Enhanced calculation and preview functionality for multiple combinations
  function updateQuotePreview() {
    let talentTotal = 0;
    let combo1Total = 0;
    
    const previewRows = document.getElementById('quote-preview-rows');
    const combo1TotalElement = document.getElementById('combo-1-total');
    
    // Clear existing rows
    if (previewRows) {
      previewRows.innerHTML = '';
    }
    
    // Calculate talent costs from active talent categories
    const activeTalentSections = document.querySelectorAll('[id^="talent-category-"]:not(.hidden)');
    let hasTalent = false;
    let baseTalentFeesOnly = 0; // Just the base fees for usage calculation
    let talentCategoryBreakdown = []; // Store breakdown for usage calculation
    
    // Get all visible talent categories and process their individual lines
    document.querySelectorAll('[id^="talent-category-"]').forEach(section => {
      if (section.classList.contains('hidden')) return;
      
      const categoryId = section.id.replace('talent-category-', '');
      const categoryName = section.querySelector('h4')?.textContent || '';
      
      // Process all talent input rows in this category
      const talentRows = section.querySelectorAll('.additional-lines .talent-input-row');
      
      talentRows.forEach(row => {
        const descriptionInput = row.querySelector('.talent-description, [name*="description"]');
        const talentCountInput = row.querySelector('.talent-count, [name*="talent_count"]');
        const rateInput = row.querySelector('.rate-adjustment, [name*="adjusted_rate"]');
        const daysInput = row.querySelector('.days-input, [name*="days_count"]');
        
        const description = descriptionInput?.value || categoryName;
        const talentCount = parseInt(talentCountInput?.value) || 0;
        const rate = parseInt(rateInput?.value) || 0;
        const days = parseInt(daysInput?.value) || 0;
        
        // Only show lines with talent count > 0
        if (talentCount > 0 && previewRows) {
          const lineTotal = talentCount * rate * days;
          combo1Total += lineTotal;
          
          const row = document.createElement('tr');
          row.className = 'border-b border-gray-300';
          row.innerHTML = `
            <td class="py-2 px-3 text-sm text-gray-800 border-r border-gray-300">${description}</td>
            <td class="py-2 px-3 text-sm text-gray-800 text-right border-r border-gray-300">R${rate.toLocaleString()}</td>
            <td class="py-2 px-3 text-sm text-gray-800 text-center border-r border-gray-300">${talentCount}</td>
            <td class="py-2 px-3 text-sm text-gray-800 text-right">R${lineTotal.toLocaleString()}</td>
          `;
          previewRows.appendChild(row);
          hasTalent = true;
        }
      });
    });
    
    // Update group 1 total
    if (combo1TotalElement) {
      combo1TotalElement.textContent = `R${combo1Total.toLocaleString()}`;
    }
    
    // If no talent lines, show placeholder
    if (!hasTalent && previewRows) {
      const emptyRow = document.createElement('tr');
      emptyRow.innerHTML = '<td colspan="4" class="py-4 text-center text-gray-500 italic">No talent selected</td>';
      previewRows.appendChild(emptyRow);
    }
    
    // TODO: Add logic for additional combos when they exist
    // This will be expanded when combo functionality is added
  }
    
    // Get campaign type for adjustments
    const campaignTypeRadio = document.querySelector('input[name="quotation[product_type]"]:checked');
    const campaignType = campaignTypeRadio ? campaignTypeRadio.value : null;

    // Get active combinations data (for now, default to empty array until combo functionality is complete)
    const activeCombinations = [];

    // Calculate Usage/Buyout for each combination (additive)
    let totalUsageBuyout = 0;
    const usageBreakdownHtml = [];

    if (activeCombinations.length > 0) {
      activeCombinations.forEach(combo => {
        const totalMultiplier = combo.territoryMultiplier * combo.mediaMultiplier * combo.durationMultiplier * combo.exclusivityMultiplier;
        let comboUsageTotal = 0;
        
        usageBreakdownHtml.push(`<div class="font-medium text-gray-800 mt-2">Group ${combo.id}:</div>`);
        
        talentCategoryBreakdown.forEach(category => {
          let categoryUsage = category.baseFees * totalMultiplier;
          let adjustmentText = '';
          
          // Apply campaign type adjustments
          if (campaignType === 'adult' && category.id === '5') { // Kid category
            categoryUsage *= 0.5; // 50% reduction for adult campaigns
            adjustmentText = ' × 50% (Adult)';
          } else if (campaignType === 'family' && category.id === '5') { // Kid category  
            categoryUsage *= 0.75; // 25% reduction for family campaigns
            adjustmentText = ' × 75% (Family)';
          }
          
          if (categoryUsage > 0) {
            comboUsageTotal += categoryUsage;
            
            usageBreakdownHtml.push(`
              <div class="flex justify-between ml-4 text-xs">
                <span>${category.name}: R${category.baseFees.toLocaleString()} × ${totalMultiplier.toFixed(2)}x${adjustmentText}</span>
                <span>R${Math.round(categoryUsage).toLocaleString()}</span>
              </div>
            `);
          }
        });
        
        totalUsageBuyout += comboUsageTotal;
        
        // Calculate additional fees for this combination
        let comboAdditionalFees = 0;
        if (combo.unlimitedStills) comboAdditionalFees += talentTotal * 0.15;
        if (combo.unlimitedVersions) comboAdditionalFees += talentTotal * 0.15;
        totalAdditionalFees += comboAdditionalFees;
        
        if (comboAdditionalFees > 0) {
          usageBreakdownHtml.push(`
            <div class="flex justify-between ml-4 text-xs text-blue-600">
              <span>Additional Options</span>
              <span>R${Math.round(comboAdditionalFees).toLocaleString()}</span>
            </div>
          `);
        }
      });
    } else {
      usageBreakdownHtml.push('<div class="text-gray-500 italic">No combinations configured</div>');
    }
    
    // A) Talent Fees = talentTotal (includes base + standby + overtime)
    const talentFees = talentTotal;
    
    // B) Usage/Buyout = Sum of all combinations
    const usageBuyoutTotal = totalUsageBuyout;
    
    // C) Total = A + B + Additional Options
    const totalQuote = talentFees + usageBuyoutTotal + totalAdditionalFees;
    
    // Update display with aggregated values
    const avgTerritoryMultiplier = activeCombinations.length > 0 ? 
      activeCombinations.reduce((sum, combo) => sum + combo.territoryMultiplier, 0) / activeCombinations.length : 1.0;
    const avgMediaMultiplier = activeCombinations.length > 0 ? 
      activeCombinations.reduce((sum, combo) => sum + combo.mediaMultiplier, 0) / activeCombinations.length : 1.0;
    const avgDurationMultiplier = activeCombinations.length > 0 ? 
      activeCombinations.reduce((sum, combo) => sum + combo.durationMultiplier, 0) / activeCombinations.length : 1.0;
    const avgExclusivityMultiplier = activeCombinations.length > 0 ? 
      activeCombinations.reduce((sum, combo) => sum + combo.exclusivityMultiplier, 0) / activeCombinations.length : 1.0;
    
    document.getElementById('talent-total').textContent = `R ${talentFees.toLocaleString()}.00`;
    document.getElementById('territory-multiplier').textContent = `${avgTerritoryMultiplier.toFixed(2)}x (avg)`;
    document.getElementById('media-display-multiplier').textContent = `${avgMediaMultiplier.toFixed(2)}x (avg)`;
    document.getElementById('duration-multiplier').textContent = `${avgDurationMultiplier.toFixed(2)}x (avg)`;
    document.getElementById('exclusivity-multiplier').textContent = avgExclusivityMultiplier > 1 ? `+${Math.round((avgExclusivityMultiplier - 1) * 100)}% (avg)` : '+0%';
    document.getElementById('usage-buyout-total').textContent = `R ${Math.round(usageBuyoutTotal).toLocaleString()}.00`;
    document.getElementById('usage-buyout-breakdown').innerHTML = usageBreakdownHtml.join('');
    document.getElementById('additional-fees').textContent = `R ${totalAdditionalFees.toLocaleString()}.00`;
    document.getElementById('total-quote').textContent = `R ${Math.round(totalQuote).toLocaleString()}.00`;
    document.getElementById('current-total').textContent = `R ${Math.round(totalQuote).toLocaleString()}.00`;
  
  
  // Add CSS for combination content visibility
  const style = document.createElement('style');
  style.textContent = `
    .combination-content {
      display: none;
    }
    .combination-content.active {
      display: block;
    }
  `;
  document.head.appendChild(style);

  // Media types mutual exclusion logic (matching quotation_form_controller.js exactly)
  function handleMediaTypeChange(comboId, changedInput) {
    const allInputs = document.querySelectorAll(`input[name="combinations[${comboId}][media_types][]"]`);
    const allMediaCheckbox = document.querySelector(`input[name="combinations[${comboId}][media_types][]"][value="all_media"]`);
    const allMovingCheckbox = document.querySelector(`input[name="combinations[${comboId}][media_types][]"][value="all_moving"]`);
    const allPrintCheckbox = document.querySelector(`input[name="combinations[${comboId}][media_types][]"][value="print"]`);
    const tvCheckbox = document.querySelector(`input[name="combinations[${comboId}][media_types][]"][value="tv"]`);
    const internetCheckbox = document.querySelector(`input[name="combinations[${comboId}][media_types][]"][value="internet"]`);
    const cinemaCheckbox = document.querySelector(`input[name="combinations[${comboId}][media_types][]"][value="cinema"]`);
    
    const value = changedInput.value;
    const isChecked = changedInput.checked;
    
    // If "All Media" is selected, uncheck and disable all others
    if (value === 'all_media' && isChecked) {
      document.querySelectorAll(`input[name="combinations[${comboId}][media_types][]"]:not([value="all_media"])`).forEach(otherCheckbox => {
        otherCheckbox.checked = false;
        otherCheckbox.disabled = true;
        otherCheckbox.closest('label').classList.add('opacity-50', 'cursor-not-allowed');
      });
    }
    // If "All Media" is unchecked, enable all others and uncheck everything
    else if (value === 'all_media' && !isChecked) {
      document.querySelectorAll(`input[name="combinations[${comboId}][media_types][]"]:not([value="all_media"])`).forEach(otherCheckbox => {
        otherCheckbox.checked = false;
        otherCheckbox.disabled = false;
        otherCheckbox.closest('label').classList.remove('opacity-50', 'cursor-not-allowed');
      });
    }
    // If "All Moving Media" is selected
    else if (value === 'all_moving' && isChecked) {
      // Auto-check TV, Internet, Cinema
      if (tvCheckbox) tvCheckbox.checked = true;
      if (internetCheckbox) internetCheckbox.checked = true;
      if (cinemaCheckbox) cinemaCheckbox.checked = true;
      
      // Disable All Print Media and All Media
      if (allPrintCheckbox) {
        allPrintCheckbox.disabled = true;
        allPrintCheckbox.closest('label').classList.add('opacity-50', 'cursor-not-allowed');
      }
      if (allMediaCheckbox) {
        allMediaCheckbox.disabled = true;
        allMediaCheckbox.closest('label').classList.add('opacity-50', 'cursor-not-allowed');
      }
    }
    // If "All Moving Media" is unchecked
    else if (value === 'all_moving' && !isChecked) {
      // Uncheck TV, Internet, Cinema
      if (tvCheckbox) tvCheckbox.checked = false;
      if (internetCheckbox) internetCheckbox.checked = false;
      if (cinemaCheckbox) cinemaCheckbox.checked = false;
      
      // Re-enable All Print Media and All Media
      if (allPrintCheckbox) {
        allPrintCheckbox.disabled = false;
        allPrintCheckbox.closest('label').classList.remove('opacity-50', 'cursor-not-allowed');
      }
      if (allMediaCheckbox) {
        allMediaCheckbox.disabled = false;
        allMediaCheckbox.closest('label').classList.remove('opacity-50', 'cursor-not-allowed');
      }
    }
    // If "All Print Media" is selected
    else if (value === 'print' && isChecked) {
      // Auto-check Internet
      if (internetCheckbox) internetCheckbox.checked = true;
      
      // Disable All Moving Media, individual moving options, and All Media
      if (allMovingCheckbox) {
        allMovingCheckbox.disabled = true;
        allMovingCheckbox.closest('label').classList.add('opacity-50', 'cursor-not-allowed');
      }
      if (tvCheckbox) {
        tvCheckbox.disabled = true;
        tvCheckbox.closest('label').classList.add('opacity-50', 'cursor-not-allowed');
      }
      if (cinemaCheckbox) {
        cinemaCheckbox.disabled = true;
        cinemaCheckbox.closest('label').classList.add('opacity-50', 'cursor-not-allowed');
      }
      if (allMediaCheckbox) {
        allMediaCheckbox.disabled = true;
        allMediaCheckbox.closest('label').classList.add('opacity-50', 'cursor-not-allowed');
      }
    }
    // If "All Print Media" is unchecked
    else if (value === 'print' && !isChecked) {
      // Uncheck Internet
      if (internetCheckbox) internetCheckbox.checked = false;
      
      // Re-enable All Moving Media, individual moving options, and All Media
      if (allMovingCheckbox) {
        allMovingCheckbox.disabled = false;
        allMovingCheckbox.closest('label').classList.remove('opacity-50', 'cursor-not-allowed');
      }
      if (tvCheckbox) {
        tvCheckbox.disabled = false;
        tvCheckbox.closest('label').classList.remove('opacity-50', 'cursor-not-allowed');
      }
      if (cinemaCheckbox) {
        cinemaCheckbox.disabled = false;
        cinemaCheckbox.closest('label').classList.remove('opacity-50', 'cursor-not-allowed');
      }
      if (allMediaCheckbox) {
        allMediaCheckbox.disabled = false;
        allMediaCheckbox.closest('label').classList.remove('opacity-50', 'cursor-not-allowed');
      }
    }
    // Handle TV, Internet, Cinema individual selections
    else if (['tv', 'internet', 'cinema'].includes(value)) {
      const tvChecked = tvCheckbox && tvCheckbox.checked;
      const internetChecked = internetCheckbox && internetCheckbox.checked;
      const cinemaChecked = cinemaCheckbox && cinemaCheckbox.checked;
      
      // Special case: If "All Print Media" was checked but user unchecks Internet
      if (value === 'internet' && allPrintCheckbox && allPrintCheckbox.checked && !internetChecked) {
        allPrintCheckbox.checked = false;
        // Re-enable All Moving Media, individual moving options, and All Media
        if (allMovingCheckbox) {
          allMovingCheckbox.disabled = false;
          allMovingCheckbox.closest('label').classList.remove('opacity-50', 'cursor-not-allowed');
        }
        if (tvCheckbox) {
          tvCheckbox.disabled = false;
          tvCheckbox.closest('label').classList.remove('opacity-50', 'cursor-not-allowed');
        }
        if (cinemaCheckbox) {
          cinemaCheckbox.disabled = false;
          cinemaCheckbox.closest('label').classList.remove('opacity-50', 'cursor-not-allowed');
        }
        if (allMediaCheckbox) {
          allMediaCheckbox.disabled = false;
          allMediaCheckbox.closest('label').classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }
      // If user manually selects all three, auto-check "All Moving Media"
      else if (tvChecked && internetChecked && cinemaChecked && allMovingCheckbox && !allMovingCheckbox.checked) {
        allMovingCheckbox.checked = true;
        // Disable All Print Media and All Media
        if (allPrintCheckbox) {
          allPrintCheckbox.disabled = true;
          allPrintCheckbox.closest('label').classList.add('opacity-50', 'cursor-not-allowed');
        }
        if (allMediaCheckbox) {
          allMediaCheckbox.disabled = true;
          allMediaCheckbox.closest('label').classList.add('opacity-50', 'cursor-not-allowed');
        }
      } 
      // If "All Moving Media" was checked but user unchecks one of TV/Internet/Cinema
      else if (allMovingCheckbox && allMovingCheckbox.checked && !(tvChecked && internetChecked && cinemaChecked)) {
        allMovingCheckbox.checked = false;
        // Re-enable All Print Media and All Media
        if (allPrintCheckbox) {
          allPrintCheckbox.disabled = false;
          allPrintCheckbox.closest('label').classList.remove('opacity-50', 'cursor-not-allowed');
        }
        if (allMediaCheckbox) {
          allMediaCheckbox.disabled = false;
          allMediaCheckbox.closest('label').classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }
    }
    // If any other checkbox is selected, uncheck "All Media"
    else if (value !== 'all_media' && isChecked && allMediaCheckbox) {
      allMediaCheckbox.checked = false;
    }
    
    calculateMediaMultiplierForCombo(comboId);
  }

  // Territory tags management
  function updateTerritoryTags(comboId) {
    const tagsContainer = document.querySelector(`.selected-territory-tags[data-combo="${comboId}"]`);
    const selectedTerritories = document.querySelectorAll(`input[name="combinations[${comboId}][territories][]"]:checked`);
    
    if (!tagsContainer) return;
    
    tagsContainer.innerHTML = '';
    
    selectedTerritories.forEach(checkbox => {
      const territoryName = checkbox.dataset.territoryName;
      const territoryId = checkbox.dataset.territoryId;
      
      const tag = document.createElement('span');
      tag.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800';
      tag.innerHTML = `
        ${territoryName}
        <button type="button" class="ml-2 inline-flex items-center justify-center w-4 h-4 text-blue-400 hover:text-blue-600" data-remove-territory-tag data-combo-id="${comboId}" data-territory-id="${territoryId}">
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </button>
      `;
      tagsContainer.appendChild(tag);
    });
  }

  // Remove territory tag function
  function removeTerritoryTag(comboId, territoryId) {
    const checkbox = document.querySelector(`input[name="combinations[${comboId}][territories][]"][value="${territoryId}"]`);
    if (checkbox) {
      checkbox.checked = false;
      updateTerritoryTags(comboId);
      if (typeof updateQuotePreview === 'function') {
        if (typeof updateQuotePreview === 'function') {
      if (typeof updateQuotePreview === 'function') {
    updateQuotePreview();
  }
    }
      }
    }
  }

  // Function will be handled by controller event delegation

  // Update preview when form values change
  document.addEventListener('input', function(e) {
    // Update media multiplier displays for combinations
    if (e.target.classList.contains('combination-media')) {
      const comboId = e.target.getAttribute('data-combo');
      calculateMediaMultiplierForCombo(comboId);
    }
    
    if (typeof updateQuotePreview === 'function') {
      if (typeof updateQuotePreview === 'function') {
    updateQuotePreview();
  }
    }
    
  });
  
  document.addEventListener('change', function(e) {
    // Handle media type changes
    if (e.target.classList.contains('combination-media')) {
      const comboId = e.target.getAttribute('data-combo');
      handleMediaTypeChange(comboId, e.target);
    }
    
    // Handle territory checkbox changes
    if (e.target.classList.contains('combination-territory-checkbox')) {
      const comboId = e.target.getAttribute('data-combo');
      updateTerritoryTags(comboId);
    }
    
    if (typeof updateQuotePreview === 'function') {
      if (typeof updateQuotePreview === 'function') {
    updateQuotePreview();
  }
    }
    
  });
  
  // Scroll spy to update sidebar
  window.addEventListener('scroll', function() {
    let current = '';
    sections.forEach(section => {
      const sectionTop = section.offsetTop;
      const sectionHeight = section.clientHeight;
      if (window.pageYOffset >= sectionTop - 200) {
        current = section.getAttribute('id');
      }
    });
    
    sidebarItems.forEach(item => {
      item.classList.remove('font-medium', 'text-blue-600');
      item.classList.add('text-gray-700');
      if (item.dataset.section === current) {
        item.classList.add('font-medium', 'text-blue-600');
        item.classList.remove('text-gray-700');
      }
    });
  });
  
  // Handle talent category selection
  document.querySelectorAll('.talent-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const categoryId = this.dataset.category;
      const section = document.getElementById(`talent-category-${categoryId}`);
      
      if (this.classList.contains('border-blue-500')) {
        // Remove category
        section.classList.add('hidden');
        this.classList.remove('border-blue-500', 'bg-blue-50');
        this.classList.add('border-gray-300');
      } else {
        // Add category
        section.classList.remove('hidden');
        this.classList.add('border-blue-500', 'bg-blue-50');
        this.classList.remove('border-gray-300');
      }
      
      if (typeof updateQuotePreview === 'function') {
        if (typeof updateQuotePreview === 'function') {
      if (typeof updateQuotePreview === 'function') {
    updateQuotePreview();
  }
    }
      }
    });
  });

  // Handle night button functionality
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('night-btn')) {
      const categoryId = e.target.dataset.category;
      const isActive = e.target.dataset.active === 'true';
      
      // Toggle active state
      e.target.dataset.active = isActive ? 'false' : 'true';
      
      if (e.target.dataset.active === 'true') {
        e.target.classList.add('bg-yellow-100', 'border-yellow-400', 'text-yellow-800');
        e.target.classList.remove('border-gray-300');
      } else {
        e.target.classList.remove('bg-yellow-100', 'border-yellow-400', 'text-yellow-800');
        e.target.classList.add('border-gray-300');
      }
      
      // Update hidden field
      const hiddenField = e.target.parentElement.querySelector(`[data-night-field="${categoryId}"]`);
      if (hiddenField) {
        hiddenField.value = e.target.dataset.active;
      }
      
      if (typeof updateQuotePreview === 'function') {
        if (typeof updateQuotePreview === 'function') {
      if (typeof updateQuotePreview === 'function') {
    updateQuotePreview();
  }
    }
      }
    }
  });

  // Handle all input changes for talent calculations
  document.addEventListener('input', function(e) {
    // Update media multiplier displays for combinations
    if (e.target.classList.contains('combination-media')) {
      const comboId = e.target.getAttribute('data-combo');
      calculateMediaMultiplierForCombo(comboId);
    }
    
    // Handle talent input changes
    if (e.target.hasAttribute('data-talent-input') || 
        e.target.hasAttribute('data-adjusted-rate-input') ||
        e.target.hasAttribute('data-days-input') ||
        e.target.hasAttribute('data-rehearsal-input') ||
        e.target.hasAttribute('data-down-input') ||
        e.target.hasAttribute('data-travel-input') ||
        e.target.hasAttribute('data-overtime-input')) {
      
      const categoryId = e.target.dataset.talentInput || 
                        e.target.dataset.adjustedRateInput ||
                        e.target.dataset.daysInput ||
                        e.target.dataset.rehearsalInput ||
                        e.target.dataset.downInput ||
                        e.target.dataset.travelInput ||
                        e.target.dataset.overtimeInput;
      
      if (categoryId) {
        updateCategoryTotal(categoryId);
      }
    }
    
    if (typeof updateQuotePreview === 'function') {
      if (typeof updateQuotePreview === 'function') {
    updateQuotePreview();
  }
    }
  });

  // Calculate category totals for talent
  function updateCategoryTotal(categoryId) {
    const section = document.getElementById(`talent-category-${categoryId}`);
    if (!section || section.classList.contains('hidden')) return;
    
    const talentCount = parseInt(section.querySelector(`[data-talent-input="${categoryId}"]`)?.value) || 0;
    const adjustedRate = parseInt(section.querySelector(`[data-adjusted-rate-input="${categoryId}"]`)?.value) || 0;
    const days = parseInt(section.querySelector(`[data-days-input="${categoryId}"]`)?.value) || 0;
    const rehearsal = parseInt(section.querySelector(`[data-rehearsal-input="${categoryId}"]`)?.value) || 0;
    const downDays = parseInt(section.querySelector(`[data-down-input="${categoryId}"]`)?.value) || 0;
    const travelDays = parseInt(section.querySelector(`[data-travel-input="${categoryId}"]`)?.value) || 0;
    const overtime = parseFloat(section.querySelector(`[data-overtime-input="${categoryId}"]`)?.value) || 0;
    
    // Check night premium from hidden field
    const nightField = section.querySelector(`[data-night-field="${categoryId}"]`);
    const nightPremium = nightField && nightField.value === 'true';
    console.log(`HTML Template - Night field found: ${!!nightField}, field value: ${nightField?.value}, nightPremium: ${nightPremium}`);
    
    let total = 0;
    
    // Base calculation
    total += talentCount * adjustedRate * days;
    
    // Rehearsal at 50%
    total += talentCount * adjustedRate * 0.5 * rehearsal;
    
    // Down days at 50%
    total += talentCount * adjustedRate * 0.5 * downDays;
    
    // Travel days at 50%
    total += talentCount * adjustedRate * 0.5 * travelDays;
    
    // Overtime at 10% per hour
    total += talentCount * adjustedRate * 0.1 * overtime;
    
    // Night premium at 50% of base rate (applies to first shoot day only)
    if (nightPremium) {
      total += talentCount * adjustedRate * 0.5;
    }
    
    // Update display
    const totalElement = section.querySelector(`#category-total-${categoryId}`);
    if (totalElement) {
      totalElement.textContent = `R${total.toLocaleString()}`;
    }
    
    if (typeof updateQuotePreview === 'function') {
      if (typeof updateQuotePreview === 'function') {
    updateQuotePreview();
  }
    }
  }

  // Initial calculation
  if (typeof updateQuotePreview === 'function') {
    updateQuotePreview();
  }
});

// Action button functions
function saveDraft() {
  // Add a hidden field to indicate draft status
  const form = document.querySelector('form');
  const draftField = document.createElement('input');
  draftField.type = 'hidden';
  draftField.name = 'save_as_draft';
  draftField.value = '1';
  form.appendChild(draftField);
  
  // Submit the form
  form.submit();
}

function previewQuote() {
  // Open preview in new window/tab
  const form = document.querySelector('form');
  const formData = new FormData(form);
  
  // You can implement preview logic here
  alert('Preview functionality will open quote preview in new window');
  
  // Or redirect to preview page
  // window.open('/quotations/preview?' + new URLSearchParams(formData).toString(), '_blank');
}

// Handle talent category selection
document.querySelectorAll('.talent-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const categoryId = this.dataset.category;
    const section = document.getElementById(`talent-category-${categoryId}`);
    
    if (this.classList.contains('border-blue-500')) {
      // Remove category
      section.classList.add('hidden');
      this.classList.remove('border-blue-500', 'bg-blue-50');
      this.classList.add('border-gray-300');
    } else {
      // Add category
      section.classList.remove('hidden');
      this.classList.add('border-blue-500', 'bg-blue-50');
      this.classList.remove('border-gray-300');
    }
    
    if (typeof updateQuotePreview === 'function') {
      if (typeof updateQuotePreview === 'function') {
    updateQuotePreview();
  }
    }
  });
});

// Handle rate adjustment plus/minus buttons
document.querySelectorAll('.rate-plus-btn, .rate-minus-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const categoryId = this.dataset.category;
    const adjustmentInput = document.querySelector(`[data-rate-adjustment-input="${categoryId}"]`);
    const currentValue = parseInt(adjustmentInput.value) || 0;
    const isPlus = this.classList.contains('rate-plus-btn');
    const increment = 100; // R100 increments
    
    const newValue = isPlus ? currentValue + increment : Math.max(0, currentValue - increment);
    adjustmentInput.value = newValue;
    
    updateAdjustedRate(categoryId);
    updateCategoryTotal(categoryId);
    if (typeof updateQuotePreview === 'function') {
      if (typeof updateQuotePreview === 'function') {
    updateQuotePreview();
  }
    }
  });

  console.log('✅ DOMContentLoaded complete - all event listeners should be set up');

  // Test button availability immediately
  setTimeout(() => {
    const btn = document.getElementById('add-combination');
    console.log('🧪 Button test after 1 second:', !!btn);
    if (btn) {
      console.log('Button is clickable:', !btn.disabled);
      console.log('Button classes:', btn.className);
    }
  }, 1000);
});

// Territories data for JavaScript
const territoriesData = <%= @territories.group_by { |t| t.group_name.present? ? t.group_name : "Individual Countries" }.map { |group_name, territories|
  [group_name, territories.map { |t| { id: t.id, name: t.name, percentage: t.percentage } }]
}.to_h.to_json.html_safe %>;

console.log('territoriesData loaded:', territoriesData);

// Helper function to generate territories HTML for a given combo ID
function generateTerritoriesHTML(comboId) {
  console.log('🌍 generateTerritoriesHTML called for combo:', comboId);
  console.log('territoriesData available:', !!territoriesData);
  let html = '';
  Object.entries(territoriesData).forEach(([groupName, territories]) => {
    territories.forEach(territory => {
      html += `
        <label class="territory-item flex items-center justify-between p-2 border-b border-gray-100 hover:bg-gray-50 cursor-pointer" data-name="${territory.name.toLowerCase()}">
          <div class="flex items-center">
            <input type="checkbox" name="combinations[${comboId}][territories][]" value="${territory.id}" class="mr-3 rounded text-blue-600 focus:ring-blue-500 combination-territory-checkbox" data-territory-id="${territory.id}" data-territory-name="${territory.name}" data-percentage="${territory.percentage}" data-combo="${comboId}">
            <div class="text-sm">
              <div class="font-medium text-gray-900">${territory.name}</div>
              <div class="text-xs text-gray-500">${groupName}</div>
            </div>
          </div>
          <div class="text-sm font-medium text-blue-600">${territory.percentage}%</div>
        </label>
      `;
    });
  });
  return html;
}

function updateAdjustedRate(categoryId) {
  const baseRates = {
    1: <%= Setting.find_by(key: 'lead_base_rate')&.typed_value || 0 %>,
    2: <%= Setting.find_by(key: 'second_lead_base_rate')&.typed_value || 0 %>,
    3: <%= Setting.find_by(key: 'featured_extra_base_rate')&.typed_value || 0 %>,
    4: <%= Setting.find_by(key: 'teenager_base_rate')&.typed_value || 0 %>,
    5: <%= Setting.find_by(key: 'kid_base_rate')&.typed_value || 0 %>,
    6: <%= Setting.find_by(key: 'walk_on_base_rate')&.typed_value || 0 %>
  };
  
  const adjustmentInput = document.querySelector(`[data-rate-adjustment-input="${categoryId}"]`);
  const adjustment = parseInt(adjustmentInput.value) || 0;
  const baseRate = baseRates[categoryId] || 0;
  const adjustedRate = baseRate + adjustment;
  
  const adjustedRateElement = document.getElementById(`adjusted-rate-${categoryId}`);
  if (adjustedRateElement) {
    const adjustmentText = adjustment >= 0 ? `+R${adjustment}` : `-R${Math.abs(adjustment)}`;
    adjustedRateElement.textContent = `${adjustmentText} = R${adjustedRate.toLocaleString()}`;
  }
  
  return adjustedRate;
}

</script>