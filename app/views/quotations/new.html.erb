<!-- app/views/quotations/new.html.erb -->
<div class="min-h-screen bg-gray-50 flex">
  <%= form_with model: @quotation, local: true, class: "w-full flex" do |f| %>
    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-lg flex flex-col sticky top-0 h-screen p-4 justify-between">
      <div class="flex-1 overflow-y-auto">
        <h2 class="text-lg font-semibold mb-4">Quote Sections</h2>
        <ul class="space-y-2 text-sm text-gray-700">
          <li class="font-medium text-blue-600 cursor-pointer" data-section="project-info">Project Information</li>
          <li class="cursor-pointer hover:text-blue-600" data-section="talent-categories">Talent Categories</li>
          <li class="cursor-pointer hover:text-blue-600" data-section="schedule">Days & Schedule</li>
          <li class="cursor-pointer hover:text-blue-600" data-section="licensing">Usage & Licensing</li>
          <li class="cursor-pointer hover:text-blue-600" data-section="territories">Territories</li>
        </ul>
      </div>
      <div class="border-t pt-4 flex-shrink-0">
        <p class="text-sm text-gray-500">Current Total</p>
        <p class="text-2xl font-bold" id="current-total">R 0.00</p>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 space-y-6">
      
      <!-- Error Messages -->
      <% if @quotation.errors.any? %>
        <div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg">
          <h3 class="font-semibold mb-2">Please correct the following errors:</h3>
          <ul class="list-disc list-inside">
            <% @quotation.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>
      
      <!-- Project Information -->
      <section id="project-info" class="bg-white shadow rounded-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">Project Information</h3>
          <span class="text-sm text-gray-400">Step 1 of 5</span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <%= f.label :project_name, "Project Name", class: "block text-sm font-medium text-gray-600" %>
            <%= f.text_field :project_name, required: true, class: "w-full mt-1 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500", placeholder: "Enter project name" %>
          </div>
          <div>
            <%= f.label :status, "Status", class: "block text-sm font-medium text-gray-600" %>
            <%= f.select :status, options_for_select(Quotation::STATUS_OPTIONS.map { |s| [s.capitalize, s] }, @quotation.status), {}, class: "w-full mt-1 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
          </div>
        </div>
      </section>

      <!-- Talent Categories -->
      <section id="talent-categories" class="bg-white shadow rounded-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">Talent Categories</h3>
          <span class="text-sm text-gray-400">Step 2 of 5</span>
        </div>
        <div class="space-y-4">
          <% TalentCategory::TYPES.each do |type_id, type_name| %>
            <div class="flex items-center justify-between border rounded-lg px-4 py-3 hover:bg-gray-50" data-category="<%= type_id %>">
              <div class="flex items-center">
                <span class="text-lg mr-3"><%= TalentCategory.new(category_type: type_id).icon %></span>
                <div>
                  <span class="font-medium"><%= type_name %></span>
                  <div class="text-xs text-gray-500">
                    Base Rate: R<%= number_with_delimiter(Setting.find_by(key: "#{type_name.downcase.gsub(/[ -]/, '_')}_base_rate")&.typed_value || 0) %>
                  </div>
                </div>
              </div>
              <div class="flex items-center space-x-3">
                <%= number_field_tag "talent_categories[#{type_id}][count]", 0, min: 0, placeholder: "Quantity", class: "w-24 border rounded-lg px-2 py-1 text-sm focus:ring-2 focus:ring-blue-500", data: { category_count: type_id } %>
                <button type="button" class="text-sm text-blue-600 hover:text-blue-800 btn-add-days-breakdown" data-category="<%= type_id %>">
                  + Days
                </button>
              </div>
            </div>
            
            <!-- Days on Set Container (hidden by default) -->
            <div class="days-on-set-container mt-2 ml-8 hidden bg-gray-50 rounded-lg p-3" data-category="<%= type_id %>">
              <div class="flex justify-between items-center mb-2">
                <h5 class="text-sm font-medium text-gray-700">Days on Set Breakdown</h5>
                <div class="text-xs text-gray-500" id="breakdown-summary-<%= type_id %>">
                  Total: 0 talent-days
                </div>
              </div>
              <div class="text-xs text-gray-600 mb-2">
                Specify how many talent work on which days. This overrides the simple quantity × shoot days calculation.
              </div>
              <div class="space-y-2 days-list">
                <!-- Days on set rows will be added here dynamically -->
              </div>
              <div class="mt-2 text-xs text-amber-600" id="validation-warning-<%= type_id %>" style="display: none;">
                ⚠️ Breakdown days should align with your total shoot days
              </div>
            </div>
          <% end %>
        </div>
      </section>

      <!-- Days on Set & Schedule -->
      <%= fields_for :quotation_detail, @quotation.quotation_detail || @quotation.build_quotation_detail do |detail_fields| %>
        <section id="schedule" class="bg-white shadow rounded-2xl p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">Days on Set & Schedule</h3>
            <span class="text-sm text-gray-400">Step 3 of 5</span>
          </div>
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
            <div class="text-sm text-blue-800">
              <strong>Note:</strong> Shoot days are used for basic calculations. If you add day-on-set breakdowns above, those will override the simple quantity × shoot days calculation for more precise costing.
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <%= detail_fields.label :shoot_days, "Shoot Days", class: "block text-sm font-medium text-gray-600" %>
              <%= detail_fields.number_field :shoot_days, value: 1, min: 1, class: "w-full mt-1 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
              <div class="text-xs text-gray-500 mt-1">Used when no day-on-set breakdown is specified</div>
            </div>
            <div>
              <%= detail_fields.label :rehearsal_days, "Rehearsal Days", class: "block text-sm font-medium text-gray-600" %>
              <%= detail_fields.number_field :rehearsal_days, value: 0, min: 0, class: "w-full mt-1 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <%= detail_fields.label :travel_days, "Travel Days", class: "block text-sm font-medium text-gray-600" %>
              <%= detail_fields.number_field :travel_days, value: 0, min: 0, class: "w-full mt-1 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
            </div>
            <div>
              <%= detail_fields.label :down_days, "Down Days", class: "block text-sm font-medium text-gray-600" %>
              <%= detail_fields.number_field :down_days, value: 0, min: 0, class: "w-full mt-1 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
            </div>
          </div>
        </section>

        <!-- Usage & Licensing -->
        <section id="licensing" class="bg-white shadow rounded-2xl p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">Usage & Licensing</h3>
            <span class="text-sm text-gray-400">Step 4 of 5</span>
          </div>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-2">Media Type</label>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                <% [['Web / Digital', 'digital'], ['TV', 'television'], ['Cinema', 'cinema'], ['Print', 'print'], ['Radio', 'radio'], ['All Media', 'all_media']].each do |label, value| %>
                  <label class="flex items-center space-x-2 p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
                    <%= detail_fields.radio_button :media_type, value, class: "text-blue-600 focus:ring-blue-500" %>
                    <span class="text-sm"><%= label %></span>
                  </label>
                <% end %>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <%= detail_fields.label :duration, "Contract Duration", class: "block text-sm font-medium text-gray-600" %>
                <%= detail_fields.select :duration,
                    options_for_select([
                      ['1 Month', '1_month'],
                      ['3 Months', '3_months'],
                      ['6 Months', '6_months'],
                      ['12 Months', '12_months'],
                      ['18 Months', '18_months'],
                      ['24 Months', '24_months'],
                      ['36 Months', '36_months']
                    ], '12_months'),
                    {}, class: "w-full mt-1 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
              </div>
            </div>
            
            <!-- Exclusivity Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <%= detail_fields.label :exclusivity_type, "Exclusivity", class: "block text-sm font-medium text-gray-600" %>
                <%= detail_fields.select :exclusivity_type,
                    options_for_select(@exclusivity_options, detail_fields.object.exclusivity_type),
                    { prompt: "Select exclusivity type" },
                    { class: "w-full mt-1 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" } %>
              </div>
            </div>
            
            <div class="space-y-2">
              <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
                <%= detail_fields.check_box :unlimited_stills, class: "mr-3 rounded text-blue-600 focus:ring-blue-500" %>
                <span class="text-sm">Unlimited Stills (+15%)</span>
              </label>
              <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
                <%= detail_fields.check_box :unlimited_versions, class: "mr-3 rounded text-blue-600 focus:ring-blue-500" %>
                <span class="text-sm">Unlimited Versions (+15%)</span>
              </label>
            </div>
          </div>
        </section>
      <% end %>

      <!-- Territories -->
      <section id="territories" class="bg-white shadow rounded-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">Territories</h3>
          <span class="text-sm text-gray-400">Step 5 of 5</span>
        </div>
        
        <!-- Search Bar -->
        <div class="mb-4">
          <input type="text" id="territory-search" placeholder="Search territories (type 3+ letters)..." 
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <!-- Territories List -->
        <div class="max-h-80 overflow-y-auto border border-gray-200 rounded-lg">
          <div id="territories-list" class="space-y-1 p-2">
            <% @territories.group_by(&:group_name).each do |group_name, territories| %>
              <% territories.each do |territory| %>
                <label class="territory-item flex items-center justify-between p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer" 
                       data-name="<%= territory.name.downcase %>">
                  <div class="flex items-center">
                    <%= check_box_tag "territories[]", territory.id, false, 
                        class: "mr-3 rounded text-blue-600 focus:ring-blue-500 territory-checkbox",
                        data: { territory_id: territory.id, territory_name: territory.name, percentage: territory.percentage } %>
                    <div class="text-sm">
                      <div class="font-medium text-gray-900"><%= territory.name %></div>
                      <div class="text-xs text-gray-500"><%= group_name %></div>
                    </div>
                  </div>
                  <div class="text-sm font-medium text-blue-600"><%= territory.percentage %>%</div>
                </label>
              <% end %>
            <% end %>
          </div>
        </div>
      </section>

      <!-- Quote Preview -->
      <section class="bg-white shadow rounded-2xl p-6">
        <h3 class="text-lg font-semibold mb-4">Quote Preview</h3>
        
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <div class="grid grid-cols-2 gap-6">
            <!-- Talent Summary -->
            <div>
              <h4 class="text-sm font-medium text-gray-600 mb-3">Talent Summary</h4>
              <div id="talent-summary" class="space-y-2 text-sm">
                <div class="text-gray-500 italic">No talent selected</div>
              </div>
            </div>
            
            <!-- Territory Summary -->
            <div>
              <h4 class="text-sm font-medium text-gray-600 mb-3">Selected Territories</h4>
              <div id="territory-summary" class="space-y-1 text-sm max-h-32 overflow-y-auto">
                <div class="text-gray-500 italic">No territories selected</div>
              </div>
            </div>
          </div>
          
          <!-- Cost Breakdown -->
          <div class="mt-6 pt-4 border-t border-gray-200">
            <div class="space-y-2">
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Talent Fees (Shoot Days):</span>
                <span id="talent-total">R 0.00</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Rehearsal/Travel/Down Days:</span>
                <span id="rehearsal-travel-total">R 0.00</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Territory Multiplier:</span>
                <span id="territory-multiplier">1.00x</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Exclusivity Multiplier:</span>
                <span id="exclusivity-multiplier">1.00x</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Usage Fees:</span>
                <span id="usage-fees">R 0.00</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Additional Options:</span>
                <span id="additional-fees">R 0.00</span>
              </div>
              <div class="flex justify-between pt-2 border-t border-gray-300 font-semibold">
                <span>Total Quote:</span>
                <span id="total-quote" class="text-blue-600">R 0.00</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Form Actions -->
      <div class="bg-white rounded-2xl p-6 shadow">
        <div class="flex flex-col space-y-3 sm:flex-row sm:space-y-0 sm:space-x-3 sm:justify-end">
          <%= link_to "Cancel", quotations_path, 
              class: "px-6 py-2 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition text-center" %>
          <%= button_tag "Save as Draft", type: "button", 
              class: "px-6 py-2 border border-blue-300 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition",
              onclick: "saveDraft()" %>
          <%= button_tag "Preview Quote", type: "button", 
              class: "px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition",
              onclick: "previewQuote()" %>
          <%= f.submit "Generate Final Quote", 
              class: "px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition" %>
        </div>
      </div>
    </main>
  <% end %>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
  // Sidebar navigation
  const sidebarItems = document.querySelectorAll('[data-section]');
  const sections = document.querySelectorAll('section[id]');
  
  sidebarItems.forEach(item => {
    item.addEventListener('click', function() {
      const targetSection = document.getElementById(this.dataset.section);
      if (targetSection) {
        targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // Update active sidebar item
        sidebarItems.forEach(i => {
          i.classList.remove('font-medium', 'text-blue-600');
          i.classList.add('text-gray-700');
        });
        this.classList.add('font-medium', 'text-blue-600');
        this.classList.remove('text-gray-700');
      }
    });
  });


  // Territory search functionality
  const territorySearch = document.getElementById('territory-search');
  const territoryItems = document.querySelectorAll('.territory-item');
  
  territorySearch.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    
    if (searchTerm.length >= 3) {
      territoryItems.forEach(item => {
        const territoryName = item.dataset.name;
        if (territoryName.includes(searchTerm)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    } else {
      // Show all items if less than 3 characters
      territoryItems.forEach(item => {
        item.style.display = 'flex';
      });
    }
  });

  // Add days breakdown functionality
  document.querySelectorAll('.btn-add-days-breakdown').forEach(button => {
    button.addEventListener('click', function() {
      const categoryId = this.dataset.category;
      const container = document.querySelector(`.days-on-set-container[data-category="${categoryId}"]`);
      const daysList = container.querySelector('.days-list');

      container.classList.remove('hidden');

      const rowIndex = daysList.children.length;
      const rowHtml = `
        <div class="flex gap-2 items-center">
          <input type="number"
                 name="talent_categories[${categoryId}][days_on_set][${rowIndex}][talent_count]"
                 placeholder="Talent count"
                 min="1"
                 class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          <span class="text-gray-500">×</span>
          <input type="number"
                 name="talent_categories[${categoryId}][days_on_set][${rowIndex}][days_count]"
                 placeholder="Days"
                 min="1"
                 class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          <button type="button" class="text-red-500 hover:text-red-700 text-sm" onclick="const categoryId = '${categoryId}'; this.parentElement.remove(); updateQuotePreview(); updateBreakdownSummary(categoryId);">
            Remove
          </button>
        </div>
      `;

      daysList.insertAdjacentHTML('beforeend', rowHtml);
      updateQuotePreview();
      updateBreakdownSummary(categoryId);
    });
  });

  // Update breakdown summary for a category
  function updateBreakdownSummary(categoryId) {
    const container = document.querySelector(`.days-on-set-container[data-category="${categoryId}"]`);
    const summaryElement = document.getElementById(`breakdown-summary-${categoryId}`);
    const warningElement = document.getElementById(`validation-warning-${categoryId}`);
    
    if (!container || container.classList.contains('hidden')) {
      return;
    }
    
    let totalTalentDays = 0;
    let maxDaysUsed = 0;
    let totalBreakdownRows = 0;
    const dayBreakdownInputs = container.querySelectorAll('input[name*="talent_count"]');
    
    dayBreakdownInputs.forEach((talentInput, index) => {
      const talentCount = parseInt(talentInput.value) || 0;
      const daysInput = container.querySelectorAll('input[name*="days_count"]')[index];
      const daysCount = parseInt(daysInput?.value) || 0;
      
      if (talentCount > 0 && daysCount > 0) {
        totalTalentDays += talentCount * daysCount;
        maxDaysUsed = Math.max(maxDaysUsed, daysCount);
        totalBreakdownRows++;
      }
    });
    
    if (summaryElement) {
      if (totalBreakdownRows === 0) {
        summaryElement.textContent = `Total: 0 talent-days`;
      } else {
        summaryElement.textContent = `Total: ${totalTalentDays} talent-days (${totalBreakdownRows} breakdown${totalBreakdownRows > 1 ? 's' : ''})`;
      }
    }
    
    // Validate against shoot days - use a more reasonable validation
    const shootDaysInput = document.querySelector('input[name*="shoot_days"]');
    const shootDays = parseInt(shootDaysInput?.value) || 1;
    
    if (warningElement) {
      if (maxDaysUsed > shootDays) {
        warningElement.style.display = 'block';
        warningElement.textContent = `⚠️ Some breakdown entries use more days (${maxDaysUsed}) than total shoot days (${shootDays})`;
      } else if (totalBreakdownRows > 0 && maxDaysUsed > 0) {
        warningElement.style.display = 'none';
      }
    }
  }

  // Enhanced calculation and preview functionality
  function updateQuotePreview() {
    let talentTotal = 0;
    let territoryMultiplier = 1.0;
    let additionalFees = 0;
    
    const talentSummary = document.getElementById('talent-summary');
    const territorySummary = document.getElementById('territory-summary');
    
    // Clear summaries
    talentSummary.innerHTML = '';
    territorySummary.innerHTML = '';
    
    // Get shoot days for calculation
    const shootDaysInput = document.querySelector('input[name*="shoot_days"]');
    const shootDays = parseInt(shootDaysInput?.value) || 1;
    
    // Base rates for each talent category (dynamically loaded from settings)
    const baseRates = {
      1: <%= Setting.find_by(key: 'lead_base_rate')&.typed_value || 0 %>,           // Lead
      2: <%= Setting.find_by(key: 'second_lead_base_rate')&.typed_value || 0 %>,   // Second Lead  
      3: <%= Setting.find_by(key: 'featured_extra_base_rate')&.typed_value || 0 %>, // Featured Extra
      4: <%= Setting.find_by(key: 'teenager_base_rate')&.typed_value || 0 %>,      // Teenager
      5: <%= Setting.find_by(key: 'kid_base_rate')&.typed_value || 0 %>,           // Kid
      6: <%= Setting.find_by(key: 'walk_on_base_rate')&.typed_value || 0 %>       // Walk-on
    };
    
    // Calculate talent costs
    const talentCounts = document.querySelectorAll('[data-category-count]');
    let hasTalent = false;
    
    talentCounts.forEach(input => {
      const quantity = parseInt(input.value) || 0;
      if (quantity > 0) {
        hasTalent = true;
        const categoryDiv = input.closest('[data-category]');
        const categoryId = parseInt(categoryDiv.dataset.category);
        const categoryName = categoryDiv.querySelector('.font-medium').textContent;
        const baseRate = baseRates[categoryId] || 0;
        
        // Check if this category has day-on-set breakdown
        const breakdownContainer = document.querySelector(`.days-on-set-container[data-category="${categoryId}"]`);
        let cost = 0;
        let costDescription = '';
        
        if (breakdownContainer && !breakdownContainer.classList.contains('hidden')) {
          // Use day-on-set breakdown calculation
          const dayBreakdownInputs = breakdownContainer.querySelectorAll('input[name*="talent_count"]');
          let totalTalentDays = 0;
          
          dayBreakdownInputs.forEach((talentInput, index) => {
            const talentCount = parseInt(talentInput.value) || 0;
            const daysInput = breakdownContainer.querySelectorAll('input[name*="days_count"]')[index];
            const daysCount = parseInt(daysInput?.value) || 0;
            
            if (talentCount > 0 && daysCount > 0) {
              const segmentCost = talentCount * daysCount * baseRate;
              cost += segmentCost;
              totalTalentDays += talentCount * daysCount;
            }
          });
          
          costDescription = `${categoryName} (breakdown: ${totalTalentDays} talent-days)`;
        } else {
          // Use simple calculation: quantity × shoot days × base rate
          cost = quantity * shootDays * baseRate;
          costDescription = `${quantity}x ${categoryName} × ${shootDays} days`;
        }
        
        talentTotal += cost;
        
        const summaryItem = document.createElement('div');
        summaryItem.className = 'flex justify-between';
        summaryItem.innerHTML = `
          <span class="text-sm">${costDescription}</span>
          <span>R ${cost.toLocaleString()}</span>
        `;
        talentSummary.appendChild(summaryItem);
      }
    });
    
    if (!hasTalent) {
      talentSummary.innerHTML = '<div class="text-gray-500 italic">No talent selected</div>';
    }
    
    // Calculate territory multipliers (use highest percentage, not additive)
    const selectedTerritories = document.querySelectorAll('.territory-checkbox:checked');
    let hasTerritory = false;
    let maxTerritoryPercentage = 0;
    let territoryNames = [];
    
    selectedTerritories.forEach(checkbox => {
      hasTerritory = true;
      const percentage = parseFloat(checkbox.dataset.percentage) || 0;
      const name = checkbox.dataset.territoryName;
      territoryNames.push(name);
      
      // Use the highest territory percentage (not additive)
      if (percentage > maxTerritoryPercentage) {
        maxTerritoryPercentage = percentage;
      }
    });
    
    // Apply territory multiplier logic
    if (hasTerritory) {
      // Check for special territory cases first
      if (territoryNames.includes('Worldwide')) {
        territoryMultiplier = 12.0;
      } else if (territoryNames.includes('USA')) {
        territoryMultiplier = 5.0;
      } else if (territoryNames.includes('Western Europe (excl. UK)')) {
        territoryMultiplier = 5.0;
      } else if (territoryNames.includes('Western Europe (incl. UK)')) {
        territoryMultiplier = 6.0;
      } else if (territoryNames.includes('Europe (excl. UK)')) {
        territoryMultiplier = 6.0;
      } else if (territoryNames.includes('Europe (incl. UK)')) {
        territoryMultiplier = 7.5;
      } else {
        territoryMultiplier = maxTerritoryPercentage / 100.0;
      }
    }
    
    // Update territory summary
    if (hasTerritory) {
      territoryNames.forEach(name => {
        const summaryItem = document.createElement('div');
        summaryItem.className = 'text-sm';
        summaryItem.innerHTML = name;
        territorySummary.appendChild(summaryItem);
      });
    } else {
      territorySummary.innerHTML = '<div class="text-gray-500 italic">No territories selected</div>';
    }
    
    // Calculate exclusivity fees
    let exclusivityMultiplier = 1.0;
    const exclusivitySelect = document.querySelector('select[name*="exclusivity_type"]');
    if (exclusivitySelect && exclusivitySelect.value) {
      // Get the percentage from the exclusivity options data
      const selectedOption = exclusivitySelect.selectedOptions[0];
      if (selectedOption) {
        const text = selectedOption.textContent;
        const percentageMatch = text.match(/\+(\d+)%/);
        if (percentageMatch) {
          const percentage = parseFloat(percentageMatch[1]) || 0;
          exclusivityMultiplier += (percentage / 100);
        }
      }
    }
    
    // Calculate additional fees
    const unlimitedStills = document.querySelector('input[name*="unlimited_stills"]:checked');
    const unlimitedVersions = document.querySelector('input[name*="unlimited_versions"]:checked');
    
    if (unlimitedStills) additionalFees += talentTotal * 0.15;
    if (unlimitedVersions) additionalFees += talentTotal * 0.15;
    
    // Calculate rehearsal/travel/down days costs
    let rehearsalTravelCost = 0;
    const rehearsalDaysInput = document.querySelector('input[name*="rehearsal_days"]');
    const travelDaysInput = document.querySelector('input[name*="travel_days"]');
    const downDaysInput = document.querySelector('input[name*="down_days"]');
    
    const rehearsalDays = parseInt(rehearsalDaysInput?.value) || 0;
    const travelDays = parseInt(travelDaysInput?.value) || 0;
    const downDays = parseInt(downDaysInput?.value) || 0;
    const extraDays = rehearsalDays + travelDays + downDays;
    
    if (extraDays > 0) {
      // Calculate for each talent category using initial_count (all hired talent)
      talentCounts.forEach(input => {
        const quantity = parseInt(input.value) || 0;
        if (quantity > 0) {
          const categoryDiv = input.closest('[data-category]');
          const categoryId = parseInt(categoryDiv.dataset.category);
          const baseRate = baseRates[categoryId] || 0;
          
          // All hired talent participate in rehearsal/travel/down at 50% rate
          rehearsalTravelCost += quantity * extraDays * baseRate * 0.5;
        }
      });
    }
    
    // Calculate usage fees (simplified for preview)
    const usageFees = talentTotal * 0.2; // 20% for usage
    
    // Calculate totals with exclusivity
    const baseCost = talentTotal + rehearsalTravelCost;
    const subtotal = baseCost * territoryMultiplier * exclusivityMultiplier;
    const totalQuote = subtotal + usageFees + additionalFees;
    
    // Update display
    document.getElementById('talent-total').textContent = `R ${talentTotal.toLocaleString()}.00`;
    document.getElementById('rehearsal-travel-total').textContent = `R ${rehearsalTravelCost.toLocaleString()}.00`;
    document.getElementById('territory-multiplier').textContent = `${territoryMultiplier.toFixed(2)}x`;
    document.getElementById('exclusivity-multiplier').textContent = `${exclusivityMultiplier.toFixed(2)}x`;
    document.getElementById('usage-fees').textContent = `R ${usageFees.toLocaleString()}.00`;
    document.getElementById('additional-fees').textContent = `R ${additionalFees.toLocaleString()}.00`;
    document.getElementById('total-quote').textContent = `R ${totalQuote.toLocaleString()}.00`;
    document.getElementById('current-total').textContent = `R ${totalQuote.toLocaleString()}.00`;
  }
  
  // Update preview when form values change
  document.addEventListener('input', function(e) {
    updateQuotePreview();
    
    // Update breakdown summaries when day breakdown inputs change
    if (e.target.name && (e.target.name.includes('talent_count') || e.target.name.includes('days_count'))) {
      const categoryMatch = e.target.name.match(/talent_categories\[(\d+)\]/);
      if (categoryMatch) {
        // Add a small delay to ensure DOM is updated
        setTimeout(() => updateBreakdownSummary(categoryMatch[1]), 10);
      }
    }
    
    // Also update if shoot days change (affects validation)
    if (e.target.name && e.target.name.includes('shoot_days')) {
      // Update all visible breakdown summaries when shoot days change
      document.querySelectorAll('.days-on-set-container:not(.hidden)').forEach(container => {
        const categoryId = container.getAttribute('data-category');
        if (categoryId) {
          setTimeout(() => updateBreakdownSummary(categoryId), 10);
        }
      });
    }
  });
  
  document.addEventListener('change', function(e) {
    updateQuotePreview();
    
    // Also handle change events for breakdown inputs
    if (e.target.name && (e.target.name.includes('talent_count') || e.target.name.includes('days_count'))) {
      const categoryMatch = e.target.name.match(/talent_categories\[(\d+)\]/);
      if (categoryMatch) {
        updateBreakdownSummary(categoryMatch[1]);
      }
    }
  });
  
  // Scroll spy to update sidebar
  window.addEventListener('scroll', function() {
    let current = '';
    sections.forEach(section => {
      const sectionTop = section.offsetTop;
      const sectionHeight = section.clientHeight;
      if (window.pageYOffset >= sectionTop - 200) {
        current = section.getAttribute('id');
      }
    });
    
    sidebarItems.forEach(item => {
      item.classList.remove('font-medium', 'text-blue-600');
      item.classList.add('text-gray-700');
      if (item.dataset.section === current) {
        item.classList.add('font-medium', 'text-blue-600');
        item.classList.remove('text-gray-700');
      }
    });
  });
  
  // Initial calculation
  updateQuotePreview();
});

// Action button functions
function saveDraft() {
  // Add a hidden field to indicate draft status
  const form = document.querySelector('form');
  const draftField = document.createElement('input');
  draftField.type = 'hidden';
  draftField.name = 'save_as_draft';
  draftField.value = '1';
  form.appendChild(draftField);
  
  // Submit the form
  form.submit();
}

function previewQuote() {
  // Open preview in new window/tab
  const form = document.querySelector('form');
  const formData = new FormData(form);
  
  // You can implement preview logic here
  alert('Preview functionality will open quote preview in new window');
  
  // Or redirect to preview page
  // window.open('/quotations/preview?' + new URLSearchParams(formData).toString(), '_blank');
}
</script>